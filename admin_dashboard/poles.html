<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการข้อมูลเสาไฟฟ้า - ระบบหลังบ้าน อบต.ข่าใหญ่</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        :root {
            --primary-color: #1e3a8a; 
            --primary-light: #3b82f6; 
            --secondary-color: #e5e7eb; 
            --accent-color: #10b981;   
            --text-dark: #1f2937;
            --text-light: #f9fafb;
            --text-muted: #6b7280;
            --border-color: #d1d5db;
            --card-bg: #ffffff;
            --font-sans: 'IBM Plex Sans Thai', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --radius-md: 0.375rem; 
            --radius-lg: 0.5rem;  
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
        }
        body {
            font-family: var(--font-sans);
            background-color: var(--secondary-color);
            margin: 0;
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background-color: #2d3748;
            color: var(--text-light);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #4a5568;}
        .sidebar-header h2 { font-size: 1.4rem; margin: 0; font-weight: 600; color: #e2e8f0; }
        .sidebar-header p { font-size: 0.8rem; color: #a0aec0; margin-top: 0.25rem; }
        .nav-menu a { display: flex; align-items: center; color: #cbd5e0; padding: 0.9rem 1.25rem; text-decoration: none; border-radius: 6px; margin-bottom: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; font-weight: 500; }
        .nav-menu a:hover { background-color: #4a5568; color: #fff; transform: translateX(3px); }
        .nav-menu a.active { background-color: var(--primary-color); color: #fff; font-weight: 600; }
        .nav-menu a svg { width: 20px; height: 20px; margin-right: 12px; opacity: 0.9; }
        .nav-menu a.active svg { opacity: 1; }

        .main-content { flex-grow: 1; padding: 2.5rem; background-color: var(--secondary-color); overflow-y: auto; }
        .content-header { margin-bottom: 1.5rem; padding-bottom: 1.5rem; /* Increased padding */ display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .content-header h1 { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin: 0;}
        .action-button { 
            padding: 0.625rem 1.25rem;
            background-color: var(--primary-light);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .action-button svg { width: 16px; height: 16px; margin-right: 0.5rem;}
        .action-button:hover { background-color: var(--primary-color); }
        .add-button { background-color: var(--accent-color); } 
        .add-button:hover { background-color: #059669; }


        .filter-controls-poles { 
            margin-bottom: 1.75rem;
            padding: 1.25rem;
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap; 
        }
        .filter-controls-poles label { font-weight: 600; margin-right: 0.5rem; color: var(--text-dark); font-size: 0.9rem;}
        .filter-controls-poles input[type="text"], .filter-controls-poles select {
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            min-width: 180px;
            background-color: #f9fafb;
        }
         .filter-controls-poles input[type="text"]:focus, .filter-controls-poles select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .filter-controls-poles button {
            font-weight: 500;
            font-size: 0.95rem;
        }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; }


        .poles-table-wrapper { overflow-x: auto; background-color: var(--card-bg); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); }
        .poles-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem; 
        }
        .poles-table th, .poles-table td {
            padding: 0.875rem 1rem; 
            border-bottom: 1px solid var(--border-color); 
            text-align: left;
            vertical-align: middle; 
        }
         .poles-table tr:last-child td { border-bottom: none; }
        .poles-table thead th {
            background-color: #f9fafb; 
            font-weight: 600; 
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            white-space: nowrap; 
        }
        .poles-table tbody tr:hover { background-color: #eff6ff; }
        .poles-table .action-link {
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 500;
            margin-right: 0.75rem; 
            padding: 0.3rem 0.6rem;
            border-radius: var(--radius-md);
            transition: background-color 0.2s, color 0.2s;
        }
        .poles-table .action-link:hover { background-color: var(--primary-light); color: var(--text-light); text-decoration: none; }
        .poles-table .delete-link { color: #ef4444; }
        .poles-table .delete-link:hover { background-color: #fee2e2; color: #ef4444; }

        .pagination-controls {
            margin-top: 1.5rem;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pagination-controls button {
            padding: 0.5rem 1rem;
            background-color: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            margin: 0 0.25rem;
            transition: background-color 0.2s ease;
        }
        .pagination-controls button:hover { background-color: var(--primary-color); }
        .pagination-controls button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        .pagination-controls .page-info { font-size: 0.9rem; color: var(--text-muted); }


        .logout-section { margin-top: auto; padding-top: 1rem; border-top: 1px solid #4a5568; }
        .logout-button { display: flex; align-items: center; background-color: transparent; color: #cbd5e0; border: 1px solid transparent; padding: 0.875rem 1.25rem; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 500; width: 100%; text-align: left; transition: background-color 0.2s ease, color 0.2s ease; }
        .logout-button:hover { background-color: #ef4444; border-color: #ef4444; color: #fff; }
        .logout-button svg { width: 16px; height: 16px; margin-right: 8px; }
        
        #globalErrorPoles {
             margin-bottom: 1.5rem; 
            display: none; 
            background-color: #fee2e2; 
            color: #991b1b; 
            padding: 1rem;
            border: 1px solid #fecaca;
            border-radius: var(--radius-md);
        }
        .message-display { text-align: center; padding: 2rem; font-size: 1rem; color: var(--text-muted); }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; flex-direction: row; justify-content: space-around; padding: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; z-index: 100; background-color: #2d3748; }
            .sidebar-header { display: none; } 
            .nav-menu { display: flex; width: 100%; justify-content: space-around; align-items: center; }
            .nav-menu a { padding: 0.5rem; margin-bottom: 0; font-size: 0.75rem; text-align: center; flex-direction: column; flex: 1; }
            .nav-menu a svg { margin-right: 0; margin-bottom: 3px; width: 18px; height: 18px;}
            .nav-menu a span { display: block; font-size: 0.7rem; } 
            .main-content { padding-top: calc(55px + 1.5rem); padding-left: 1rem; padding-right: 1rem; }
            .logout-section { display: none; } 
            .content-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .content-header h1 { font-size: 1.6rem; }
            .action-button.add-button { width: 100%; justify-content: center; }
            .filter-controls-poles { flex-direction: column; align-items: stretch; }
            .filter-controls-poles > .filter-group { width: 100%; margin-bottom: 0.75rem; }
            .filter-controls-poles button { width: 100%; }
            .poles-table th, .poles-table td { padding: 0.6rem; font-size: 0.85rem;}
            .pagination-controls { flex-direction: column; gap: 0.5rem;}
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>อบต.ข่าใหญ่</h2>
            <p>ระบบหลังบ้าน</p>
        </div>
        <nav class="nav-menu">
            <a href="/admin/dashboard">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 018.25 20.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25A2.25 2.25 0 0113.5 8.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                <span>แดชบอร์ด</span>
            </a>
            <a href="/admin/requests"> 
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                <span>รายการแจ้งซ่อม</span>
            </a>
            <a href="/admin/poles" class="active"> 
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" /></svg>
                <span>ข้อมูลเสาไฟฟ้า</span>
            </a>
            <a href="/admin/inventory"> 
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008" /></svg>
                <span>คลังวัสดุ</span>
            </a>
             <a href="/admin/users"> 
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                <span>จัดการผู้ใช้</span>
            </a>
        </nav>
        <div class="logout-section">
            <button class="logout-button" id="logoutButton">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                ออกจากระบบ
            </button>
        </div>
    </aside>

    <main class="main-content">
        <header class="content-header">
            <h1>จัดการข้อมูลเสาไฟฟ้า</h1>
            <a href="/admin/pole-form.html" class="action-button add-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                เพิ่มเสาไฟฟ้าใหม่
            </a>
        </header>
        <div id="globalErrorPoles" class="error-message-display"></div>

        <div class="filter-controls-poles">
            <div class="filter-group">
                <label for="villageFilter">หมู่บ้าน:</label>
                <select id="villageFilter">
                    <option value="">ทั้งหมด</option>
                    <option value="หมู่ 2 บ้านดอนเข็มเหนือ">หมู่ 2 บ้านดอนเข็มเหนือ</option>
                    <option value="หมู่ 3 บ้านข่าใหญ่">หมู่ 3 บ้านข่าใหญ่</option>
                    <option value="หมู่ 6 บ้านดินทรายอ่อนใต้">หมู่ 6 บ้านดินทรายอ่อนใต้</option>
                    <option value="หมู่ 7 บ้านนาล้อม">หมู่ 7 บ้านนาล้อม</option>
                    <option value="หมู่ 8 บ้านหนองแสงใต้">หมู่ 8 บ้านหนองแสงใต้</option>
                    <option value="หมู่ 10 บ้านดอนหัน">หมู่ 10 บ้านดอนหัน</option>
                    <option value="หมู่ 11 บ้านข่าน้อย">หมู่ 11 บ้านข่าน้อย</option>
                    <option value="หมู่ 12 บ้านดินทรายอ่อนเหนือ">หมู่ 12 บ้านดินทรายอ่อนเหนือ</option>
                    <option value="หมู่ 14 บ้านหนองแสงเหนือ">หมู่ 14 บ้านหนองแสงเหนือ</option>
                    <option value="หมู่ 15 บ้านดอนเข็มใต้">หมู่ 15 บ้านดอนเข็มใต้</option>
                    <option value="หมู่ 16 บ้านทรายทอง">หมู่ 16 บ้านทรายทอง</option>
                    <option value="อื่นๆ/ไม่ระบุ">อื่นๆ/ไม่ระบุ</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="poleSearchInput">ค้นหา:</label>
                <input type="text" id="poleSearchInput" placeholder="รหัสเสา, ประเภท, หมายเหตุ...">
            </div>
             <div class="filter-group">
                <label for="itemsPerPageSelect">แสดง:</label>
                <select id="itemsPerPageSelect">
                    <option value="10">10 รายการ</option>
                    <option value="30">30 รายการ</option>
                    <option value="50">50 รายการ</option>
                    <option value="100">100 รายการ</option>
                    <option value="0">ทั้งหมด</option>
                </select>
            </div>
            <button id="poleFilterButton" class="action-button">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:16px; height:16px; margin-right:5px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                ใช้ตัวกรอง
            </button>
        </div>

        <div class="poles-table-wrapper">
            <table class="poles-table">
                <thead>
                    <tr>
                        <th>รหัสเสาไฟฟ้า</th>
                        <th>หมู่บ้าน</th>
                        <th>ประเภทเสา</th>
                        <th>ชนิดเสา</th>
                        <th>ละติจูด</th>
                        <th>ลองจิจูด</th>
                        <th>ชนิดหลอด</th>
                        <th>ขนาดวัตต์</th>
                        <th>วันที่ติดตั้ง</th>
                        <th>ดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="polesTableBody">
                    <tr><td colspan="10" class="message-display">กำลังโหลดข้อมูลเสาไฟฟ้า...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="paginationControlsPoles" class="pagination-controls" style="display: none;">
            <button id="prevPageButtonPoles" disabled>&laquo; ก่อนหน้า</button>
            <span id="pageInfoPoles">หน้า 1 จาก 1</span>
            <button id="nextPageButtonPoles" disabled>ถัดไป &raquo;</button>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const POLE_API_INTERNAL_KEYS = {
            POLE_ID: 'POLE_ID_HEADER', 
            VILLAGE: 'VILLAGE_HEADER',
            POLE_TYPE: 'POLE_TYPE_HEADER',
            POLE_SUBTYPE: 'POLE_SUBTYPE_HEADER',
            LATITUDE: 'LATITUDE_HEADER',
            LONGITUDE: 'LONGITUDE_HEADER',
            LAMP_TYPE: 'LAMP_TYPE_HEADER',
            WATTAGE: 'WATTAGE_HEADER',
            INSTALL_DATE: 'INSTALL_DATE_HEADER',
            NOTES: 'NOTES_HEADER', 
            QR_CODE: 'QR_CODE_HEADER' 
        };

        let allFetchedPoles = []; // To store all poles fetched from API for client-side pagination/filtering
        let currentPagePoles = 1;
        let itemsPerPagePoles = 10;


        async function fetchDataAdmin(url, options = {}) {
            const authToken = localStorage.getItem('adminAuthToken');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            try {
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication error.');
                        Swal.fire({
                            title: 'ข้อผิดพลาดในการยืนยันตัวตน',
                            text: `(${response.status}) ${errorData.message || 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง'}`,
                            icon: 'error',
                            confirmButtonText: 'ไปหน้าล็อกอิน',
                            willClose: () => {
                                // window.location.href = '/admin/login?session=expired';
                            }
                        });
                        throw new Error(`Authentication Failed (${response.status})`);
                    }
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching admin data:', error);
                const globalErrorDiv = document.getElementById('globalErrorPoles'); 
                if(globalErrorDiv) {
                    globalErrorDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}.`;
                    globalErrorDiv.style.display = 'block';
                }
                 Swal.fire({ 
                    title: 'เกิดข้อผิดพลาด',
                    text: `ไม่สามารถโหลดข้อมูลได้: ${error.message}`,
                    icon: 'error',
                    confirmButtonText: 'ตกลง'
                });
                throw error; 
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const authToken = localStorage.getItem('adminAuthToken');
             if (!authToken && !(window.location.pathname === '/admin/login.html' || window.location.pathname === '/admin/login')) {
                // window.location.href = '/admin/login';
                 console.warn('Admin token not found. For development, direct access is allowed.');
            }

            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function() {
                    localStorage.removeItem('adminAuthToken');
                     Swal.fire({
                        title: 'ออกจากระบบสำเร็จ',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false,
                        willClose: () => {
                            window.location.href = '/admin/login'; 
                        }
                    });
                });
            }
            
            const poleFilterButton = document.getElementById('poleFilterButton');
            if(poleFilterButton){
                poleFilterButton.addEventListener('click', () => {
                    currentPagePoles = 1; // Reset to first page on new filter/search
                    fetchAllPoles(true);
                });
            }
            const poleSearchInput = document.getElementById('poleSearchInput');
            if(poleSearchInput){
                poleSearchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        currentPagePoles = 1;
                        fetchAllPoles(true);
                    }
                });
            }
            const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
            if(itemsPerPageSelect){
                itemsPerPageSelect.addEventListener('change', (event) => {
                    itemsPerPagePoles = parseInt(event.target.value) || 0; // 0 for all
                    currentPagePoles = 1;
                    renderPolesTable(); // Re-render with new items per page
                });
            }
            
            fetchAllPoles(false); 
        });

        async function fetchAllPoles(isFilterAction = false) {
            const tableBody = document.getElementById('polesTableBody');
            const globalErrorDiv = document.getElementById('globalErrorPoles');
            const paginationControls = document.getElementById('paginationControlsPoles');

            if(!tableBody || !globalErrorDiv || !paginationControls) {
                console.error("Required elements for poles table/pagination not found!");
                return;
            }
            globalErrorDiv.style.display = 'none';
            tableBody.innerHTML = '<tr><td colspan="10" class="message-display">กำลังโหลดข้อมูลเสาไฟฟ้า...</td></tr>';
            paginationControls.style.display = 'none';
            
            try {
                // Fetch ALL poles from API, client-side filtering and pagination will be applied
                const result = await fetchDataAdmin(`/api/admin/poles`); 

                if (result.status === 'success') {
                    allFetchedPoles = result.data; // Store all fetched data
                    currentPagePoles = 1; // Reset to first page
                    renderPolesTable(isFilterAction);
                } else {
                     tableBody.innerHTML = `<tr><td colspan="10" class="message-display">${result.message || 'ไม่สามารถโหลดข้อมูลเสาไฟฟ้าได้'}</td></tr>`;
                }
            } catch (error) {
                console.error('Error fetching/displaying poles:', error);
                tableBody.innerHTML = `<tr><td colspan="10" class="message-display">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            }
        }

        function renderPolesTable(isFilterAction = false) {
            const tableBody = document.getElementById('polesTableBody');
            const villageFilterValue = document.getElementById('villageFilter').value;
            const searchInputValue = document.getElementById('poleSearchInput').value.trim().toLowerCase();
            
            let filteredPoles = allFetchedPoles;

            if (villageFilterValue) {
                filteredPoles = filteredPoles.filter(pole => pole[POLE_API_INTERNAL_KEYS.VILLAGE] === villageFilterValue);
            }
            if (searchInputValue) {
                filteredPoles = filteredPoles.filter(pole => 
                    (pole[POLE_API_INTERNAL_KEYS.POLE_ID] && String(pole[POLE_API_INTERNAL_KEYS.POLE_ID]).toLowerCase().includes(searchInputValue)) ||
                    (pole[POLE_API_INTERNAL_KEYS.POLE_TYPE] && String(pole[POLE_API_INTERNAL_KEYS.POLE_TYPE]).toLowerCase().includes(searchInputValue)) ||
                    (pole[POLE_API_INTERNAL_KEYS.NOTES] && String(pole[POLE_API_INTERNAL_KEYS.NOTES]).toLowerCase().includes(searchInputValue))
                );
            }

            if (filteredPoles.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="message-display">${isFilterAction || villageFilterValue || searchInputValue ? 'ไม่พบข้อมูลเสาไฟฟ้าตามเงื่อนไข' : 'ยังไม่มีข้อมูลเสาไฟฟ้า'}</td></tr>`;
                document.getElementById('paginationControlsPoles').style.display = 'none';
                return;
            }

            tableBody.innerHTML = ''; // Clear previous rows or loading message
            
            const startIndex = itemsPerPagePoles > 0 ? (currentPagePoles - 1) * itemsPerPagePoles : 0;
            const endIndex = itemsPerPagePoles > 0 ? startIndex + itemsPerPagePoles : filteredPoles.length;
            const paginatedPoles = filteredPoles.slice(startIndex, endIndex);

            paginatedPoles.forEach(pole => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.POLE_ID] || 'N/A';
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.VILLAGE] || 'N/A';
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.POLE_TYPE] || 'N/A';
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.POLE_SUBTYPE] || 'N/A';
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.LATITUDE] || 'N/A';
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.LONGITUDE] || 'N/A';
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.LAMP_TYPE] || 'N/A';
                row.insertCell().textContent = pole[POLE_API_INTERNAL_KEYS.WATTAGE] || 'N/A';
                
                let installDateDisplay = 'N/A';
                if (pole[POLE_API_INTERNAL_KEYS.INSTALL_DATE]) {
                    try {
                        const dateParts = pole[POLE_API_INTERNAL_KEYS.INSTALL_DATE].split('/');
                        if (dateParts.length === 3) {
                            let year = parseInt(dateParts[2]);
                            if (year > 2500) year -= 543; 
                            installDateDisplay = `${dateParts[0]}/${dateParts[1]}/${year}`;
                        } else { installDateDisplay = pole[POLE_API_INTERNAL_KEYS.INSTALL_DATE]; }
                    } catch (e) { installDateDisplay = pole[POLE_API_INTERNAL_KEYS.INSTALL_DATE]; }
                }
                row.insertCell().textContent = installDateDisplay;
                
                const actionsCell = row.insertCell();
                const editButton = document.createElement('a');
                const poleIdForUrl = encodeURIComponent(pole[POLE_API_INTERNAL_KEYS.POLE_ID]);
                editButton.href = `/admin/pole-form.html?id=${poleIdForUrl}`; 
                editButton.textContent = 'แก้ไข';
                editButton.classList.add('action-link');
                actionsCell.appendChild(editButton);
            });
            
            setupPaginationPoles(filteredPoles.length);
        }

        function setupPaginationPoles(totalItems) {
            const paginationControls = document.getElementById('paginationControlsPoles');
            const pageInfo = document.getElementById('pageInfoPoles');
            const prevButton = document.getElementById('prevPageButtonPoles');
            const nextButton = document.getElementById('nextPageButtonPoles');

            if (!paginationControls || !pageInfo || !prevButton || !nextButton) return;

            if (itemsPerPagePoles === 0 || totalItems <= itemsPerPagePoles) { // Show all or only one page
                paginationControls.style.display = 'none';
                return;
            }
            paginationControls.style.display = 'flex';

            const totalPages = Math.ceil(totalItems / itemsPerPagePoles);
            pageInfo.textContent = `หน้า ${currentPagePoles} จาก ${totalPages}`;

            prevButton.disabled = currentPagePoles === 1;
            nextButton.disabled = currentPagePoles === totalPages;

            prevButton.onclick = () => {
                if (currentPagePoles > 1) {
                    currentPagePoles--;
                    renderPolesTable();
                }
            };
            nextButton.onclick = () => {
                if (currentPagePoles < totalPages) {
                    currentPagePoles++;
                    renderPolesTable();
                }
            };
        }

    </script>
</body>
</html>

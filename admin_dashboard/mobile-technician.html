<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ - ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.1/sweetalert2.all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom SweetAlert2 Styles */
        .swal2-popup {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95)) !important;
            border: 2px solid rgba(251, 191, 36, 0.3) !important;
            border-radius: 1rem !important;
            color: #f8fafc !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
        }

        .swal2-title {
            color: #fbbf24 !important;
            font-weight: 700 !important;
        }

        .swal2-content {
            color: #f8fafc !important;
        }

        .swal2-confirm {
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
            color: #0f172a !important;
            border: none !important;
            border-radius: 0.5rem !important;
            font-weight: 600 !important;
            padding: 0.75rem 1.5rem !important;
            font-size: 1rem !important;
            transition: all 0.3s ease !important;
        }

        .swal2-confirm:hover {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            transform: translateY(-2px) !important;
        }

        .swal2-cancel {
            background: rgba(148, 163, 184, 0.2) !important;
            color: #f8fafc !important;
            border: 1px solid rgba(148, 163, 184, 0.3) !important;
            border-radius: 0.5rem !important;
            font-weight: 600 !important;
            padding: 0.75rem 1.5rem !important;
            font-size: 1rem !important;
            transition: all 0.3s ease !important;
        }

        .swal2-cancel:hover {
            background: rgba(148, 163, 184, 0.3) !important;
            transform: translateY(-2px) !important;
        }

        .swal2-input, .swal2-textarea {
            background: rgba(15, 23, 42, 0.5) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            border-radius: 0.5rem !important;
            color: #f8fafc !important;
            padding: 0.75rem 1rem !important;
        }

        .swal2-input:focus, .swal2-textarea:focus {
            border-color: #fbbf24 !important;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2) !important;
            outline: none !important;
        }

        .swal2-icon.swal2-success .swal2-success-ring {
            border-color: #10b981 !important;
        }

        .swal2-icon.swal2-error {
            border-color: #ef4444 !important;
            color: #ef4444 !important;
        }

        .swal2-icon.swal2-warning {
            border-color: #f59e0b !important;
            color: #f59e0b !important;
        }

        .swal2-icon.swal2-info {
            border-color: #3b82f6 !important;
            color: #3b82f6 !important;
        }

        .swal2-icon.swal2-question {
            border-color: #fbbf24 !important;
            color: #fbbf24 !important;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            padding: 1rem 2rem;
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-icon {
            font-size: 2.5rem;
            color: #0f172a;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.2); }
        }

        .header-title {
            color: #0f172a;
            font-size: 1.5rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header-subtitle {
            color: #374151;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            background: rgba(15, 23, 42, 0.2);
            transition: all 0.3s ease;
        }

        .header-user:hover {
            background: rgba(15, 23, 42, 0.4);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            color: #0f172a;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-role {
            color: #374151;
            font-size: 0.8rem;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(251, 191, 36, 0.3);
            padding: 1rem 0.5rem;
            display: flex;
            justify-content: space-around;
            z-index: 90;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.8rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #94a3b8;
            font-size: 0.75rem;
            text-align: center;
            min-width: 70px;
        }

        .nav-item.active {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            transform: translateY(-2px);
        }

        .nav-item:hover:not(.active) {
            color: #f8fafc;
            background: rgba(248, 250, 252, 0.1);
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 1.4rem;
            margin-bottom: 0.25rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            padding-bottom: 6rem;
        }

        /* Section Title */
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            font-size: 2rem;
            color: #f59e0b;
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s ease;
        }

        .card:hover::before {
            animation: shine 0.6s ease-in-out;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .section-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.2);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .section-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
        }

        .section-content {
            padding: 1.5rem 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .stat-content h3 {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-content p {
            font-size: 2rem;
            font-weight: 800;
            color: #fbbf24;
            line-height: 1;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-approved {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-in-progress {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .status-completed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        /* Request Cards */
        .request-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
        }

        .request-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .request-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .request-id {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fbbf24;
        }

        .request-info {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .request-info-icon {
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 0.75rem;
            color: #fbbf24;
        }

        /* Inventory Styles */
        .inventory-item {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 59, 0.4));
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
            transition: all 0.3s ease;
        }

        .inventory-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .inventory-name {
            font-weight: 600;
            color: #f8fafc;
            font-size: 1rem;
        }

        .inventory-stock {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .stock-badge {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .stock-low {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .stock-normal {
            background: rgba(16, 185, 129, 0.2);
            color: #86efac;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .quantity-btn {
            width: 2.5rem;
            height: 2.5rem;
            border: 2px solid rgba(251, 191, 36, 0.3);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            color: #fbbf24;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            border-color: #fbbf24;
            transform: scale(1.1);
        }

        /* Reports Actions */
        .reports-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .action-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
        }

        .action-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(251, 191, 36, 0.3);
            border-color: rgba(251, 191, 36, 0.6);
        }

        .action-card.reports {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1));
            border-color: rgba(139, 92, 246, 0.3);
        }

        .action-card.print {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border-color: rgba(16, 185, 129, 0.3);
        }

        .action-card.export {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(29, 78, 216, 0.1));
            border-color: rgba(59, 130, 246, 0.3);
        }

        .action-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .action-card.reports .action-icon { color: #8b5cf6; }
        .action-card.print .action-icon { color: #10b981; }
        .action-card.export .action-icon { color: #3b82f6; }

        .action-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 0.5rem;
        }

        .action-description {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Filter Controls */
        .filter-controls {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 59, 0.4));
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #0f172a;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: #f8fafc;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.3);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fbbf24;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #94a3b8;
            cursor: pointer;
            transition: color 0.3s ease;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .modal-close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 0.5rem;
            font-size: 1rem;
            background: rgba(15, 23, 42, 0.5);
            color: #f8fafc;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
            background: rgba(15, 23, 42, 0.7);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Print Preview */
        .print-preview {
            background: white;
            color: black;
            padding: 2rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        .print-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #fbbf24;
        }

        .print-logo {
            font-size: 2rem;
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }

        .print-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .print-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .print-content {
            margin-bottom: 2rem;
        }

        .print-section {
            margin-bottom: 1.5rem;
        }

        .print-section-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .print-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .print-info-item {
            display: flex;
            flex-direction: column;
        }

        .print-info-label {
            font-weight: 500;
            color: #6b7280;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .print-info-value {
            color: #1f2937;
            font-size: 0.9rem;
        }

        .print-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 0.8rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .action-buttons-row {
            display: flex;
            gap: 1rem;
        }

        .action-buttons-row .btn {
            flex: 1;
        }

        /* Navigation Button */
        .navigation-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 1rem 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .navigation-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        /* Back Button */
        .back-btn {
            background: none;
            border: none;
            color: #fbbf24;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(251, 191, 36, 0.1);
            transform: translateX(-4px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #94a3b8;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: #64748b;
        }

        /* Detail View */
        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            color: #f8fafc;
            font-size: 1rem;
            padding: 0.5rem 0;
        }

        /* GPS Info */
        .gps-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(29, 78, 216, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #93c5fd;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .gps-icon {
            font-size: 1.2rem;
        }

        /* Profile Page Styles */
        .profile-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .profile-info-item {
            background: rgba(15, 23, 42, 0.3);
            padding: 1rem 1.25rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .profile-info-item strong {
            color: #fbbf24;
        }

        @media (min-width: 640px) {
            .profile-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Report Modal Styles */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .report-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .report-modal-content {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
            border-radius: 1rem;
            width: 100%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            border: 1px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.7);
            transform: scale(0.8) translateY(30px);
            transition: all 0.3s ease;
        }

        .report-modal.show .report-modal-content {
            transform: scale(1) translateY(0);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 2px solid rgba(251, 191, 36, 0.3);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
        }

        .report-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .report-title h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fbbf24;
            margin: 0;
        }

        .report-title .report-icon {
            font-size: 2.5rem;
            color: #f59e0b;
        }

        .report-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .report-body {
            padding: 2rem;
        }

        .report-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.6));
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(251, 191, 36, 0.2);
            transition: all 0.3s ease;
        }

        .report-stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(251, 191, 36, 0.4);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.2);
        }

        .report-stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .report-stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }

        .report-stat-label {
            font-size: 0.9rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .report-chart-container {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.6));
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
            overflow: hidden !important;
            max-height: 400px !important;
        }

        .report-chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 1rem;
            text-align: center;
        }

        .report-table-container {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.6));
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .report-table th,
        .report-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .report-table th {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-table td {
            color: #f8fafc;
            font-size: 0.9rem;
        }

        .report-table tr:hover {
            background: rgba(251, 191, 36, 0.05);
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .w-full {
            width: 100%;
        }

        /* Loading Animation */
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
                padding-bottom: 6rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }

            .action-buttons-row {
                flex-direction: column;
            }

            .header {
                padding: 1rem;
            }
            
            .header-title {
                font-size: 1.2rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .reports-actions {
                grid-template-columns: 1fr;
            }

            .report-charts {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .report-modal-content {
                margin: 0.5rem;
                max-height: 98vh;
            }
            
            .report-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .report-body {
                padding: 1rem;
            }
            
            .report-stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .report-title h2 {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 480px) {
            .bottom-nav {
                padding: 0.75rem 0.25rem;
            }
            
            .nav-item {
                padding: 0.5rem 0.25rem;
                font-size: 0.7rem;
                min-width: 60px;
            }
            
            .nav-icon {
                font-size: 1.2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <div class="header-icon">‚ö°</div>
                <div>
                    <h1 class="header-title" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</h1>
                    <p class="header-subtitle">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏ä‡πà‡∏≤‡∏á<span id="userDisplay">Loading...</span> - ‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á</p>
                </div>
            </div>
            <div class="header-user" onclick="showProfilePage()">
                <div class="user-avatar" id="userAvatar">T</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboardPage">
                <!-- Stats Section -->
                <section class="stats-section">
                    <h2 class="section-title">
                        <span class="section-icon">üìä</span>
                        ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                    </h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-icon electric">‚ö°</span>
                            <h3 class="stat-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                            <div class="stat-value" id="totalAssigned">-</div>
                            <div class="stat-change">
                                <span>üìã</span>
                                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <span class="stat-icon requests">‚è≥</span>
                            <h3 class="stat-title">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                            <div class="stat-value" id="pendingWork" style="color: #f59e0b;">-</div>
                            <div class="stat-change">
                                <span>üîÑ</span>
                                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <span class="stat-icon users">üîß</span>
                            <h3 class="stat-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                            <div class="stat-value" id="inProgressWork" style="color: #3b82f6;">-</div>
                            <div class="stat-change">
                                <span>‚öôÔ∏è</span>
                                <span>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <span class="stat-icon inventory">‚úÖ</span>
                            <h3 class="stat-title">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h3>
                            <div class="stat-value" id="completedWork" style="color: #10b981;">-</div>
                            <div class="stat-change">
                                <span>üéØ</span>
                                <span>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Approved Requests Section -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title">
                            ‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                        </div>
                        <span id="approvedBadge" class="status-badge status-approved">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="section-content">
                        <div id="approvedRequests"></div>
                    </div>
                </div>

                <!-- Pending Requests Section -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title">
                            ‚è∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </div>
                        <span id="pendingBadge" class="status-badge status-pending">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="section-content">
                        <div id="pendingRequests"></div>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reportsPage" class="hidden">
                <section>
                    <h2 class="section-title">
                        <span class="section-icon">üìä</span>
                        ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
                    </h2>
                    
                    <!-- Quick Reports - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Admin -->
                    <div class="reports-actions">
                        <div class="action-card reports" onclick="openMyWorkSummaryReport()">
                            <span class="action-icon">üìä</span>
                            <h3 class="action-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
                            <p class="action-description">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏°‡∏µ Charts ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</p>
                        </div>
                        
                        <div class="action-card print" onclick="showPrintReportModal()">
                            <span class="action-icon">üñ®Ô∏è</span>
                            <h3 class="action-title">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                            <p class="action-description">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö PDF</p>
                        </div>
                        
                        <div class="action-card export" onclick="showExportModal()">
                            <span class="action-icon">üì§</span>
                            <h3 class="action-title">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <p class="action-description">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô Telegram</p>
                        </div>

                        <div class="action-card reports" onclick="showCustomWorkReportModal()">
                            <span class="action-icon">üéØ</span>
                            <h3 class="action-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</h3>
                            <p class="action-description">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
                        </div>
                    </div>

                    <!-- Status Reports ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á -->
                    <div class="stats-section">
                        <h3 class="section-title" style="font-size: 1.4rem;">
                            <span class="section-icon">üîç</span>
                            ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô
                        </h3>
                        <div class="stats-grid">
                            <div class="stat-card" onclick="filterWorkByStatus('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á')" style="cursor: pointer;">
                                <span class="stat-icon requests">‚è≥</span>
                                <h3 class="stat-title">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</h3>
                                <div class="stat-value" id="waitingForTechCount">-</div>
                                <div class="stat-change">
                                    <span>üëÜ</span>
                                    <span>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                </div>
                            </div>
                            
                            <div class="stat-card" onclick="filterWorkByStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')" style="cursor: pointer;">
                                <span class="stat-icon electric">üîß</span>
                                <h3 class="stat-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</h3>
                                <div class="stat-value" id="currentlyWorkingCount">-</div>
                                <div class="stat-change">
                                    <span>üëÜ</span>
                                    <span>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                </div>
                            </div>
                            
                            <div class="stat-card" onclick="filterWorkByStatus('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')" style="cursor: pointer;">
                                <span class="stat-icon users">‚úÖ</span>
                                <h3 class="stat-title">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
                                <div class="stat-value" id="completedWorkCount">-</div>
                                <div class="stat-change">
                                    <span>üëÜ</span>
                                    <span>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                </div>
                            </div>
                            
                            <div class="stat-card" onclick="showMyWorkDetailedReport()" style="cursor: pointer;">
                                <span class="stat-icon inventory">üìà</span>
                                <h3 class="stat-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                                <div class="stat-value">üìÑ</div>
                                <div class="stat-change">
                                    <span>üëÜ</span>
                                    <span>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <h3 style="color: #fbbf24; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </h3>
                        <div class="filter-grid">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">üìÖ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="filterDateFrom" class="form-input">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">üìÖ ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="filterDateTo" class="form-input">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                <select id="filterStatus" class="form-select">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                    <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á</option>
                                    <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                    <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0; display: flex; align-items: end;">
                                <button class="btn btn-primary w-full" onclick="applyFilters()">
                                    üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filtered Results -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-title">
                                üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°
                            </div>
                            <span id="filteredResultsBadge" class="status-badge status-approved">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <div class="section-content">
                            <div id="filteredResults"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Inventory Page -->
            <div id="inventoryPage" class="hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #fbbf24; display: flex; align-items: center; gap: 0.75rem;">
                            üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                        </h2>
                        <button class="btn btn-primary" onclick="showAddInventoryModal()">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                        </button>
                    </div>
                    <div id="inventoryList"></div>
                </div>
            </div>

            <!-- Poles Page -->
            <div id="polesPage" class="hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #fbbf24; display: flex; align-items: center; gap: 0.75rem;">
                            üóº ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
                        </h2>
                        <button class="btn btn-primary" onclick="showAddPoleModal()">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
                        </button>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                            <input type="text" id="poleSearchInput" class="form-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤..." style="flex: 1;">
                            <button class="btn btn-secondary" onclick="searchPoles()">üîç</button>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1.5rem;">
                            <label style="font-weight: 600; color: #fbbf24;">üìç ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô:</label>
                            <select id="villageFilter" class="form-input" style="flex: 1;" onchange="filterByVillage()">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(29, 78, 216, 0.1)); padding: 1rem; border-radius: 0.75rem; text-align: center; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;" id="totalPolesCount">0</div>
                            <div style="font-size: 0.8rem; color: #93c5fd;">‡πÄ‡∏™‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); padding: 1rem; border-radius: 0.75rem; text-align: center; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="villageCount">0</div>
                            <div style="font-size: 0.8rem; color: #86efac;">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); padding: 1rem; border-radius: 0.75rem; text-align: center; border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;" id="filteredCount">0</div>
                            <div style="font-size: 0.8rem; color: #fcd34d;">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>
                        </div>
                    </div>
                </div>
                
                <div id="polesList"></div>
                
                <div class="card" id="polesPagination" style="text-align: center;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-secondary" id="prevPageBtn" onclick="changePage(-1)" disabled>
                            ‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                        </button>
                        <span id="paginationInfo" style="font-size: 0.9rem; color: #94a3b8;">
                            ‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏à‡∏≤‡∏Å 1
                        </span>
                        <button class="btn btn-secondary" id="nextPageBtn" onclick="changePage(1)" disabled>
                            ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è
                        </button>
                    </div>
                </div>
            </div>

            <!-- Detail Page -->
            <div id="detailPage" class="hidden">
                <button class="back-btn" onclick="showDashboard()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <div class="card" id="requestDetails"></div>
                <div class="action-buttons" id="actionButtons"></div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="hidden">
                <button class="back-btn" onclick="showDashboard()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div class="user-avatar" id="profilePageAvatar" style="width: 4rem; height: 4rem; font-size: 2rem;">T</div>
                        <div>
                            <h2 id="profilePageUsername" style="font-size: 1.25rem; font-weight: 600; color: #fbbf24;">Username</h2>
                            <p id="profilePageRole" style="color: #94a3b8;">Role</p>
                        </div>
                    </div>

                    <div class="profile-info-grid">
                        <div class="profile-info-item">
                            <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°:</strong> <span id="profilePageFullName">-</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="profilePageEmail">-</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> <span id="profilePageLastLogin">-</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="profilePageStatus">-</span>
                        </div>
                    </div>

                    <div class="mt-4" style="display: flex; flex-direction: column; gap: 1rem;">
                        <button class="btn btn-secondary w-full" onclick="showChangePasswordModal()">üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
                        <button class="btn btn-danger w-full" onclick="handleLogout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showDashboard()">
                <div class="nav-icon">üè†</div>
                <div>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
            </div>
            <div class="nav-item" onclick="showReportsPage()">
                <div class="nav-icon">üìä</div>
                <div>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            </div>
            <div class="nav-item" onclick="showInventoryPage()">
                <div class="nav-icon">üì¶</div>
                <div>‡∏Ñ‡∏•‡∏±‡∏á</div>
            </div>
            <div class="nav-item" onclick="showPolesPage()">
                <div class="nav-icon">üóº</div>
                <div>‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</div>
            </div>
            <div class="nav-item" onclick="showProfilePage()">
                <div class="nav-icon">üë§</div>
                <div>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
            </div>
        </nav>

        <!-- Modals -->
        
        <!-- Work Summary Report Modal (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Admin) -->
        <div id="workSummaryReportModal" class="report-modal">
            <div class="report-modal-content">
                <div class="report-header">
                    <div class="report-title">
                        <span class="report-icon" id="workReportIcon">üìä</span>
                        <h2 id="workReportTitle">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-secondary" onclick="printWorkReport()" style="padding: 0.75rem 1rem;">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
                        </button>
                        <button class="btn btn-success" onclick="refreshWorkReport()" style="padding: 0.75rem 1rem;">
                            üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                        <button class="btn btn-primary" onclick="sendWorkReportToTelegram()" style="padding: 0.75rem 1rem;">
                            üì± ‡∏™‡πà‡∏á Telegram
                        </button>
                        <button class="modal-close" onclick="closeWorkSummaryReportModal()" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 1.2rem;">
                            √ó
                        </button>
                    </div>
                </div>
                
                <div class="report-body">
                    <!-- Stats Cards -->
                    <div class="report-stats-grid" id="workReportStatsGrid">
                        <!-- Dynamic stats will be inserted here -->
                    </div>
                    
                    <!-- Charts -->
                    <div class="report-charts">
                        <div class="report-chart-container">
                            <h3 class="report-chart-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h3>
                            <canvas id="workStatusChart" width="400" height="300"></canvas>
                        </div>
                        <div class="report-chart-container">
                            <h3 class="report-chart-title">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                            <canvas id="workTrendChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                    
                    <!-- Data Table -->
                    <div class="report-table-container">
                        <h3 class="report-chart-title">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>
                        <div style="overflow-x: auto;">
                            <table class="report-table" id="workReportTable">
                                <thead id="workReportTableHead">
                                    <!-- Dynamic table headers -->
                                </thead>
                                <tbody id="workReportTableBody">
                                    <!-- Dynamic table rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Work Report Modal -->
        <div id="customWorkReportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üéØ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                    <button class="modal-close" onclick="closeCustomWorkReportModal()">√ó</button>
                </div>
                <form id="customWorkReportForm">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <input type="date" id="workDateFrom" class="form-input" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô">
                            <input type="date" id="workDateTo" class="form-input" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</label>
                        <select id="workStatus" class="form-select">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</option>
                            <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
                            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                        <select id="workReportType" class="form-select">
                            <option value="summary">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</option>
                            <option value="detailed">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</option>
                            <option value="performance">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                        <button type="button" class="btn btn-secondary" onclick="closeCustomWorkReportModal()" style="flex: 1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Print Report Modal -->
        <div id="printReportModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>
                    <button class="modal-close" onclick="closePrintReportModal()">√ó</button>
                </div>
                
                <!-- Report Options -->
                <div class="form-group">
                    <label class="form-label">üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <select id="reportType" class="form-select" onchange="updatePrintPreview()">
                        <option value="summary">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</option>
                        <option value="detailed">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</option>
                        <option value="completed">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">üìÖ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="printDateFrom" class="form-input" onchange="updatePrintPreview()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">üìÖ ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="printDateTo" class="form-input" onchange="updatePrintPreview()">
                    </div>
                </div>

                <!-- Print Preview -->
                <div class="form-group">
                    <label class="form-label">üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <div class="print-preview" id="printPreview">
                        <div class="print-header">
                            <div class="print-logo">‚ö°</div>
                            <div class="print-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</div>
                            <div class="print-subtitle">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</div>
                        </div>
                        <div class="print-content" id="printContent">
                            <p style="text-align: center; color: #6b7280; padding: 2rem;">
                                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                            </p>
                        </div>
                        <div class="print-footer">
                            <p>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="printDate"></span> | ‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ: <span id="printTechnician"></span></p>
                        </div>
                    </div>
                </div>

                <div class="action-buttons-row" style="margin-top: 2rem;">
                    <button class="btn btn-success" onclick="generatePDF()" id="generatePDFBtn">
                        üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
                    </button>
                    <button class="btn btn-info" onclick="printReport()">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                    <button class="btn btn-secondary" onclick="closePrintReportModal()">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="exportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <button class="modal-close" onclick="closeExportModal()">√ó</button>
                </div>
                <div style="display: grid; gap: 1rem;">
                    <button class="btn btn-primary" onclick="exportToPDF()">
                        üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF
                    </button>
                    <button class="btn btn-success" onclick="sendToTelegram()" id="telegramBtn">
                        üì± ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Telegram
                    </button>
                    <button class="btn btn-secondary" onclick="closeExportModal()">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Print Request Detail Modal -->
        <div id="printRequestDetailModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>
                    <button class="modal-close" onclick="closePrintRequestDetailModal()">√ó</button>
                </div>
                
                <!-- Detail Preview -->
                <div class="form-group">
                    <label class="form-label">üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                    <div class="print-preview" id="requestDetailPreview">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>

                <div class="action-buttons-row" style="margin-top: 2rem;">
                    <button class="btn btn-success" onclick="generateRequestPDF()">
                        üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
                    </button>
                    <button class="btn btn-info" onclick="printRequestDetail()">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                    <button class="btn btn-secondary" onclick="closePrintRequestDetailModal()">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Inventory Modal -->
        <div id="addInventoryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h3>
                    <button class="modal-close" onclick="closeAddInventoryModal()">√ó</button>
                </div>
                <form id="addInventoryForm">
                    <div class="form-group">
                        <label class="form-label">üì¶ ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                        <input type="text" id="itemName" class="form-input" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏ü LED">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìè ‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                        <input type="text" id="itemUnit" class="form-input" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏´‡∏•‡∏≠‡∏î">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                        <input type="number" id="itemPrice" class="form-input" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="number" id="itemStock" class="form-input" required placeholder="0">
                    </div>
                    <div class="action-buttons" style="flex-direction: row;">
                        <button type="submit" class="btn btn-primary" style="flex:1;">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddInventoryModal()" style="flex:1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Pole Modal -->
        <div id="addPoleModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">üóº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                    <button class="modal-close" onclick="closeAddPoleModal()">√ó</button>
                </div>
                <form id="addPoleForm">
                    <div class="form-group">
                        <label class="form-label">üè∑Ô∏è ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label>
                        <input type="text" id="poleId" class="form-input" required placeholder="‡πÄ‡∏ä‡πà‡∏ô P001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üèòÔ∏è ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                        <input type="text" id="poleVillage" class="form-input" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡πà 1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üèóÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤</label>
                        <select id="poleType" class="form-input">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                            <option value="‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï">‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</option>
                            <option value="‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å">‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å</option>
                            <option value="‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå">‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üîß ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏™‡∏≤</label>
                        <input type="text" id="poleSubtype" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 9 ‡πÄ‡∏°‡∏ï‡∏£">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</label>
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <button type="button" class="btn btn-info" onclick="getCurrentLocation('add')" id="getLocationBtn">
                                üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <div style="flex: 1;">
                                <label class="form-label" style="margin-bottom: 0.25rem;">Latitude</label>
                                <input type="number" id="poleLatitude" class="form-input" step="any" placeholder="‡πÄ‡∏ä‡πà‡∏ô 14.123456">
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label" style="margin-bottom: 0.25rem;">Longitude</label>
                                <input type="number" id="poleLongitude" class="form-input" step="any" placeholder="‡πÄ‡∏ä‡πà‡∏ô 101.123456">
                            </div>
                        </div>
                        <div id="locationStatus" style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem; display: none;">
                            üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...
                        </div>
                        <div class="gps-info">
                            <span class="gps-icon">üí°</span>
                            <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ GPS ‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí° ‡∏ä‡∏ô‡∏¥‡∏î‡∏´‡∏•‡∏≠‡∏î</label>
                        <input type="text" id="poleLampType" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô LED, Sodium">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‚ö° ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏±‡∏ï‡∏ï‡πå</label>
                        <input type="number" id="poleWattage" class="form-input" placeholder="150">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</label>
                        <input type="date" id="poleInstallDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üè¢ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</label>
                        <input type="text" id="poleInstallCompany" class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="poleNotes" class="form-textarea" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>
                    <div class="action-buttons" style="flex-direction: row;">
                        <button type="submit" class="btn btn-primary" style="flex:1;">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddPoleModal()" style="flex:1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Pole Modal -->
        <div id="editPoleModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h3>
                    <button class="modal-close" onclick="closeEditPoleModal()">√ó</button>
                </div>
                <form id="editPoleForm">
                    <input type="hidden" id="editPoleOriginalId">
                    <div class="form-group">
                        <label class="form-label">üè∑Ô∏è ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label>
                        <input type="text" id="editPoleId" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üèòÔ∏è ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                        <input type="text" id="editPoleVillage" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üèóÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤</label>
                        <select id="editPoleType" class="form-input">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                            <option value="‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï">‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</option>
                            <option value="‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å">‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å</option>
                            <option value="‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå">‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üîß ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏™‡∏≤</label>
                        <input type="text" id="editPoleSubtype" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 9 ‡πÄ‡∏°‡∏ï‡∏£">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</label>
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <button type="button" class="btn btn-info" onclick="getCurrentLocation('edit')" id="editGetLocationBtn">
                                üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <div style="flex: 1;">
                                <label class="form-label" style="margin-bottom: 0.25rem;">Latitude</label>
                                <input type="number" id="editPoleLatitude" class="form-input" step="any" placeholder="‡πÄ‡∏ä‡πà‡∏ô 14.123456">
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label" style="margin-bottom: 0.25rem;">Longitude</label>
                                <input type="number" id="editPoleLongitude" class="form-input" step="any" placeholder="‡πÄ‡∏ä‡πà‡∏ô 101.123456">
                            </div>
                        </div>
                        <div id="editLocationStatus" style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem; display: none;">
                            üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...
                        </div>
                        <div class="gps-info">
                            <span class="gps-icon">üí°</span>
                            <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ GPS ‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí° ‡∏ä‡∏ô‡∏¥‡∏î‡∏´‡∏•‡∏≠‡∏î</label>
                        <input type="text" id="editPoleLampType" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô LED, Sodium">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‚ö° ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏±‡∏ï‡∏ï‡πå</label>
                        <input type="number" id="editPoleWattage" class="form-input" placeholder="150">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</label>
                        <input type="date" id="editPoleInstallDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üè¢ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</label>
                        <input type="text" id="editPoleInstallCompany" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="editPoleNotes" class="form-textarea" rows="3"></textarea>
                    </div>
                    <div class="action-buttons" style="flex-direction: row;">
                        <button type="submit" class="btn btn-success" style="flex:1;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditPoleModal()" style="flex:1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Adjust Inventory Modal -->
        <div id="adjustInventoryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">‚öôÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                    <button class="modal-close" onclick="closeAdjustInventoryModal()">√ó</button>
                </div>
                <div id="adjustInventoryContent">
                    <div class="mb-4">
                        <label class="form-label">üì¶ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: <span id="adjustItemName"></span></label>
                        <p class="text-sm" style="color: #94a3b8;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="adjustCurrentStock"></span></p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <select id="adjustType" class="form-input">
                            <option value="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤">üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å)</option>
                            <option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢">üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢ (‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" id="adjustQuantity" class="form-input" min="1" required placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö">
                    </div>
                    <div class="action-buttons" style="flex-direction: row;">
                        <button class="btn btn-primary" onclick="confirmAdjustInventory()" style="flex:1;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button class="btn btn-secondary" onclick="closeAdjustInventoryModal()" style="flex:1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div id="changePasswordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                    <button class="modal-close" onclick="closeChangePasswordModal()">√ó</button>
                </div>
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label class="form-label">üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                        <input type="password" id="currentPassword" class="form-input" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üÜï ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                        <input type="password" id="newPasswordChange" class="form-input" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                        <input type="password" id="confirmNewPassword" class="form-input" required placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    </div>
                    <div class="action-buttons" style="margin-top: 1.5rem; flex-direction: row;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()" style="flex: 1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/auth-utils.js"></script>
    
    <script>
        // Global variables
        let currentUser = null;
        let allRequests = [];
        let filteredRequests = [];
        let allInventory = [];
        let allPoles = [];
        let filteredPoles = [];
        let selectedRequest = null;
        let selectedInventoryItem = null;
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentVillageFilter = '';
        let currentSearchQuery = '';
        let currentWorkReportData = null;
        let currentWorkReportType = '';
        let workStatusChart = null;
        let workTrendChart = null;

        // Page identifiers
        const PAGES = ['dashboard', 'reports', 'inventory', 'poles', 'detail', 'profile'];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Protect this page (require technician or admin role)
            if (!window.AuthUtils.protectPage(['technician', 'admin'])) {
                return; 
            }

            const authUser = window.AuthUtils.getCurrentUser();
            if (authUser && authUser.user) {
                try {
                    const userDetailsResponse = await window.AuthUtils.apiCall(`/api/admin/users/${encodeURIComponent(authUser.user.username)}`);
                    const userDetailsData = await userDetailsResponse.json();

                    if (userDetailsData.status === 'success' && userDetailsData.data) {
                        currentUser = {
                            username: userDetailsData.data.USERNAME,
                            role: userDetailsData.data.ROLE,
                            fullName: userDetailsData.data.FULL_NAME,
                            email: userDetailsData.data.EMAIL,
                            lastLogin: userDetailsData.data.LAST_LOGIN,
                            isActive: userDetailsData.data.IS_ACTIVE === 'TRUE', 
                            token: authUser.token
                        };
                    } else {
                        currentUser = {
                            username: authUser.user.username,
                            role: authUser.user.role,
                            token: authUser.token,
                            fullName: authUser.user.username, 
                            email: '-',
                            lastLogin: '-',
                            isActive: true 
                        };
                    }
                } catch (error) {
                    console.error("Error fetching user details:", error);
                    currentUser = {
                        username: authUser.user.username,
                        role: authUser.user.role,
                        token: authUser.token,
                        fullName: authUser.user.username,
                        email: '-',
                        lastLogin: '-',
                        isActive: true
                    };
                }
                
                updateUserDisplay();
                setupEventListeners();
                loadData();
                showDashboard();
                showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ! üîß', 'success');
            } else {
                window.AuthUtils.forceLogout('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            }
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userDisplay').textContent = currentUser.username;
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
                const avatar = document.getElementById('userAvatar');
                avatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }
        }

        function setupEventListeners() {
            document.getElementById('addInventoryForm').addEventListener('submit', handleAddInventory);
            document.getElementById('addPoleForm').addEventListener('submit', handleAddPole);
            document.getElementById('editPoleForm').addEventListener('submit', handleEditPole);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            document.getElementById('customWorkReportForm').addEventListener('submit', handleCustomWorkReport);
            
            const poleSearchInput = document.getElementById('poleSearchInput');
            if (poleSearchInput) {
                 poleSearchInput.addEventListener('input', function() {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        searchPoles();
                    }, 300);
                });
            }

            // Set default dates for filters
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('filterDateFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filterDateTo').value = today.toISOString().split('T')[0];
            document.getElementById('printDateFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('printDateTo').value = today.toISOString().split('T')[0];
        }

        function showDashboard() {
            setActivePage('dashboard', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', 0);
        }

        function showReportsPage() {
            setActivePage('reports', '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå', 1);
            applyFilters(); // Load default filtered data
        }

        function showInventoryPage() {
            setActivePage('inventory', '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', 2);
            loadInventory();
        }

        function showPolesPage() {
            setActivePage('poles', '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 3);
            loadPoles();
        }

        function showProfilePage() {
            setActivePage('profile', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß', 4);
            populateProfilePage();
        }

        function showDetailPage(request) {
            selectedRequest = request;
            setActivePage('detail', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô', -1);
            renderRequestDetail();
        }

        function setActivePage(pageId, title, navIndex) {
            document.getElementById('pageTitle').textContent = title;
            
            PAGES.forEach(page => {
                const pageElement = document.getElementById(page + 'Page');
                if (pageElement) pageElement.classList.add('hidden');
            });
            
            const activePageElement = document.getElementById(pageId + 'Page');
            if (activePageElement) activePageElement.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                if (index === navIndex) {
                    item.classList.add('active');
                }
            });
        }

        function populateProfilePage() {
            if (!currentUser) return;

            document.getElementById('profilePageAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
            document.getElementById('profilePageUsername').textContent = currentUser.username;
            document.getElementById('profilePageRole').textContent = getRoleDisplayName(currentUser.role);
            document.getElementById('profilePageFullName').textContent = currentUser.fullName || '-';
            document.getElementById('profilePageEmail').textContent = currentUser.email || '-';
            document.getElementById('profilePageLastLogin').textContent = currentUser.lastLogin ? new Date(currentUser.lastLogin).toLocaleString('th-TH') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ';
            document.getElementById('profilePageStatus').textContent = currentUser.isActive ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        }

        async function loadData() {
            await Promise.all([loadRequests(), loadInventory()]);
        }

        async function loadRequests() {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/repair-requests?limit=200');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allRequests = data.data || [];
                    updateDashboardStats();
                    renderRequestsSections();
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }

        async function loadInventory() {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/inventory');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allInventory = data.data || [];
                    updateInventoryStats();
                    renderInventoryList();
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }

        async function loadPoles() {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/poles');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allPoles = data.data || [];
                    filteredPoles = [...allPoles]; 
                    currentPage = 1; 
                    applyFiltersAndRenderPoles(); 
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading poles:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }

        function updateDashboardStats() {
            const approvedRequests = allRequests.filter(r => r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á');
            const inProgressRequests = allRequests.filter(r => r.STATUS === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
            const completedRequests = allRequests.filter(r => r.STATUS === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard Stats
            document.getElementById('totalAssigned').textContent = allRequests.length;
            document.getElementById('pendingWork').textContent = allRequests.filter(r => r.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
            document.getElementById('inProgressWork').textContent = inProgressRequests.length;
            document.getElementById('completedWork').textContent = completedRequests.length;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Reports Page Stats
            document.getElementById('waitingForTechCount').textContent = approvedRequests.length;
            document.getElementById('currentlyWorkingCount').textContent = inProgressRequests.length;
            document.getElementById('completedWorkCount').textContent = completedRequests.length;
        }

        function updateInventoryStats() {
            const lowStockCount = allInventory.filter(item => item.CURRENT_STOCK < 10).length;
            const invCountEl = document.getElementById('inventoryCount');
            if (invCountEl) invCountEl.textContent = lowStockCount;
        }

        function renderRequestsSections() {
            const approvedRequests = allRequests.filter(r => r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á' || r.STATUS === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
            const pendingRequests = allRequests.filter(r => r.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
            
            const approvedBadgeEl = document.getElementById('approvedBadge');
            if (approvedBadgeEl) approvedBadgeEl.textContent = `${approvedRequests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            const pendingBadgeEl = document.getElementById('pendingBadge');
            if (pendingBadgeEl) pendingBadgeEl.textContent = `${pendingRequests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            
            const approvedContainer = document.getElementById('approvedRequests');
            if (approvedContainer) {
                if (approvedRequests.length === 0) {
                    approvedContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">‚úÖ</div>
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                    `;
                } else {
                    approvedContainer.innerHTML = approvedRequests.map(request => `
                        <div class="request-card" onclick='showDetailPage(${JSON.stringify(request).replace(/'/g, "&apos;")})'>
                            <div class="request-header">
                                <span class="request-id">üé´ ${request.REQUEST_ID}</span>
                                <span class="status-badge ${getStatusClass(request.STATUS)}">${request.STATUS || '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á'}</span>
                            </div>
                            <div class="request-info">
                                <span class="request-info-icon">üë§</span>
                                <span style="color: #f8fafc;">${request.TITLE_PREFIX} ${request.FIRST_NAME} ${request.LAST_NAME}</span>
                            </div>
                            <div class="request-info">
                                <span class="request-info-icon">üìç</span>
                                <span>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO}, ${request.MOO}</span>
                            </div>
                            <p style="font-size: 0.9rem; color: #94a3b8; margin-top: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.3); border-radius: 0.5rem; border-left: 4px solid #fbbf24;">
                                <strong style="color: #fbbf24;">üîß ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> ${request.REASON}
                            </p>
                        </div>
                    `).join('');
                }
            }
            
            const pendingContainer = document.getElementById('pendingRequests');
            if (pendingContainer) {
                if (pendingRequests.length === 0) {
                    pendingContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">‚è∞</div>
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                    `;
                } else {
                    pendingContainer.innerHTML = pendingRequests.map(request => `
                        <div class="request-card" onclick='showDetailPage(${JSON.stringify(request).replace(/'/g, "&apos;")})'>
                            <div class="request-header">
                                <span class="request-id">üé´ ${request.REQUEST_ID}</span>
                                <span class="status-badge ${getStatusClass(request.STATUS)}">${request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span>
                            </div>
                            <div class="request-info">
                                <span class="request-info-icon">üë§</span>
                                <span style="color: #f8fafc;">${request.TITLE_PREFIX} ${request.FIRST_NAME} ${request.LAST_NAME}</span>
                            </div>
                            <div class="request-info">
                                <span class="request-info-icon">üìç</span>
                                <span>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO}, ${request.MOO}</span>
                            </div>
                            <p style="font-size: 0.9rem; color: #94a3b8; margin-top: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.3); border-radius: 0.5rem; border-left: 4px solid #fbbf24;">
                                <strong style="color: #fbbf24;">üîß ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> ${request.REASON}
                            </p>
                        </div>
                    `).join('');
                }
            }
        }

        // Work Report Functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Admin)
        async function openMyWorkSummaryReport() {
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô...', 'info');
                
                const reportData = await loadWorkReportData('summary');
                if (reportData) {
                    currentWorkReportData = reportData;
                    currentWorkReportType = 'summary';
                    
                    showWorkReportModal('summary', reportData);
                    showToast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìä', 'success');
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error opening work report:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        async function showMyWorkDetailedReport() {
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...', 'info');
                
                const reportData = await loadWorkReportData('detailed');
                if (reportData) {
                    currentWorkReportData = reportData;
                    currentWorkReportType = 'detailed';
                    
                    showWorkReportModal('detailed', reportData);
                    showToast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÑ', 'success');
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error opening detailed report:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        async function loadWorkReportData(type) {
            try {
                // Filter requests data for current technician
                const myRequests = allRequests; // In real app, filter by technician
                
                // Filter data based on report type
                const filteredData = filterDataByType(myRequests, type);
                
                // Generate statistics
                const stats = generateWorkStatistics(filteredData);
                
                return {
                    type: type,
                    data: filteredData,
                    stats: stats,
                    metadata: {
                        totalRequests: filteredData.length,
                        generatedAt: new Date().toISOString(),
                        technician: currentUser ? currentUser.username : 'Unknown',
                        dateRange: getDateRangeForType(type)
                    }
                };
            } catch (error) {
                console.error('Error loading work report data:', error);
                throw error;
            }
        }

        function filterDataByType(requests, type) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (type) {
                case 'today':
                    return requests.filter(r => {
                        const reqDate = new Date(r.DATE_REPORTED);
                        return reqDate >= today;
                    });
                
                case 'thisWeek':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return requests.filter(r => {
                        const reqDate = new Date(r.DATE_REPORTED);
                        return reqDate >= weekStart;
                    });
                
                case 'thisMonth':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return requests.filter(r => {
                        const reqDate = new Date(r.DATE_REPORTED);
                        return reqDate >= monthStart;
                    });
                
                case 'pending':
                    return requests.filter(r => 
                        r.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' || r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á'
                    );
                
                case 'inProgress':
                    return requests.filter(r => r.STATUS === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
                
                case 'completed':
                    return requests.filter(r => r.STATUS === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                
                case 'summary':
                case 'detailed':
                default:
                    return requests;
            }
        }

        function generateWorkStatistics(data) {
            const stats = {
                total: data.length,
                pending: data.filter(r => r.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length,
                waitingForTech: data.filter(r => r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á').length,
                inProgress: data.filter(r => r.STATUS === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length,
                completed: data.filter(r => r.STATUS === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length,
                cancelled: data.filter(r => r.STATUS === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å').length,
                withPhotos: data.filter(r => r.PHOTO_BASE64).length,
                avgResponseTime: 0 // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            };
            
            // Generate monthly trend data
            const monthlyData = {};
            data.forEach(r => {
                const month = new Date(r.DATE_REPORTED).toISOString().substring(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            stats.monthlyTrend = Object.entries(monthlyData)
                .sort(([a], [b]) => a.localeCompare(b))
                .slice(-6); // Last 6 months
            
            return stats;
        }

        function getDateRangeForType(type) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (type) {
                case 'today':
                    return {
                        from: today.toISOString().split('T')[0],
                        to: today.toISOString().split('T')[0]
                    };
                case 'thisWeek':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return {
                        from: weekStart.toISOString().split('T')[0],
                        to: today.toISOString().split('T')[0]
                    };
                case 'thisMonth':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return {
                        from: monthStart.toISOString().split('T')[0],
                        to: today.toISOString().split('T')[0]
                    };
                default:
                    return {
                        from: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                        to: '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'
                    };
            }
        }

        function showWorkReportModal(type, reportData) {
            const reportConfig = {
                summary: { title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô', icon: 'üìä' },
                detailed: { title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏á‡∏≤‡∏ô', icon: 'üìÑ' },
                today: { title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', icon: 'üìà' },
                thisWeek: { title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ', icon: 'üìÖ' },
                thisMonth: { title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ', icon: 'üìÜ' },
                performance: { title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û', icon: 'üéØ' }
            };
            
            const config = reportConfig[type] || reportConfig.summary;
            
            // Set modal title and icon
            document.getElementById('workReportTitle').textContent = config.title;
            document.getElementById('workReportIcon').textContent = config.icon;
            
            // Generate stats cards
            generateWorkStatsCards(reportData.stats);
            
            // Generate charts
            generateWorkCharts(reportData.stats);
            
            // Generate table
            generateWorkReportTable(reportData.data, type);
            
            // Show modal
            document.getElementById('workSummaryReportModal').classList.add('show');
        }

        function generateWorkStatsCards(stats) {
            const statsGrid = document.getElementById('workReportStatsGrid');
            
            const statsCards = [
                { icon: 'üìã', value: stats.total, label: '‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', color: '#3b82f6' },
                { icon: '‚è≥', value: stats.pending, label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', color: '#fbbf24' },
                { icon: '‚úÖ', value: stats.waitingForTech, label: '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', color: '#10b981' },
                { icon: 'üîß', value: stats.inProgress, label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', color: '#f59e0b' },
                { icon: '‚ú®', value: stats.completed, label: '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à', color: '#22c55e' },
                { icon: 'üì∏', value: stats.withPhotos, label: '‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', color: '#8b5cf6' }
            ];
            
            statsGrid.innerHTML = statsCards.map(card => `
                <div class="report-stat-card">
                    <span class="report-stat-icon" style="color: ${card.color};">${card.icon}</span>
                    <div class="report-stat-value">${card.value}</div>
                    <div class="report-stat-label">${card.label}</div>
                </div>
            `).join('');
        }

        function generateWorkCharts(stats) {
            // Destroy existing charts
            if (workStatusChart) {
                workStatusChart.destroy();
            }
            if (workTrendChart) {
                workTrendChart.destroy();
            }
            
            // Status Pie Chart
            const statusCtx = document.getElementById('workStatusChart').getContext('2d');
            workStatusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à'],
                    datasets: [{
                        data: [stats.pending, stats.waitingForTech, stats.inProgress, stats.completed],
                        backgroundColor: ['#fbbf24', '#10b981', '#f59e0b', '#22c55e'],
                        borderColor: ['#f59e0b', '#059669', '#d97706', '#16a34a'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f8fafc',
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
            
            // Trend Line Chart
            const trendCtx = document.getElementById('workTrendChart').getContext('2d');
            const trendLabels = stats.monthlyTrend.map(([month]) => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('th-TH', { month: 'short', year: 'numeric' });
            });
            const trendData = stats.monthlyTrend.map(([, count]) => count);
            
            workTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°',
                        data: trendData,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f8fafc',
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.2)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.2)' }
                        }
                    }
                }
            });
        }

        function generateWorkReportTable(data, type) {
            const tableHead = document.getElementById('workReportTableHead');
            const tableBody = document.getElementById('workReportTableBody');
            
            // Table headers
            tableHead.innerHTML = `
                <tr>
                    <th>üé´ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠</th>
                    <th>üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                    <th>üìç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                    <th>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                    <th>üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                </tr>
            `;
            
            // Table rows
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 3rem; color: #94a3b8;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = data.slice(0, 50).map(request => { // Show max 50 rows
                const fullName = `${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}`.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const statusClass = getWorkStatusBadgeClass(request.STATUS);
                const dateReported = new Date(request.DATE_REPORTED).toLocaleDateString('th-TH');
                
                return `
                    <tr>
                        <td style="font-weight: 600; color: #fbbf24;">${request.REQUEST_ID}</td>
                        <td>${fullName}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            üóº ${request.POLE_ID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                            <small style="color: #94a3b8;">${request.PROBLEM_DESCRIPTION || request.REASON || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</small>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${request.STATUS || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                        </td>
                        <td>${dateReported}</td>
                        <td>${request.PHONE || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                    </tr>
                `;
            }).join('');
            
            // Add "show more" message if data is truncated
            if (data.length > 50) {
                tableBody.innerHTML += `
                    <tr style="background: rgba(251, 191, 36, 0.1);">
                        <td colspan="6" style="text-align: center; padding: 1.5rem; color: #fbbf24; font-weight: 600;">
                            üìÑ ‡πÅ‡∏™‡∏î‡∏á 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </td>
                    </tr>
                `;
            }
        }

        function getWorkStatusBadgeClass(status) {
            switch (status) {
                case '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 
                    return 'status-pending';
                case '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á':
                    return 'status-approved';
                case '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 
                    return 'status-in-progress';
                case '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': 
                    return 'status-completed';
                case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å':
                case '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£':
                    return 'status-cancelled';
                default: 
                    return 'status-pending';
            }
        }

        function closeWorkSummaryReportModal() {
            document.getElementById('workSummaryReportModal').classList.remove('show');
            
            // Destroy charts when closing
            if (workStatusChart) {
                workStatusChart.destroy();
                workStatusChart = null;
            }
            if (workTrendChart) {
                workTrendChart.destroy();
                workTrendChart = null;
            }
        }

        function printWorkReport() {
            window.print();
            showToast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô üñ®Ô∏è', 'success');
        }

        function refreshWorkReport() {
            if (currentWorkReportType) {
                closeWorkSummaryReportModal();
                setTimeout(() => {
                    if (currentWorkReportType === 'summary') {
                        openMyWorkSummaryReport();
                    } else if (currentWorkReportType === 'detailed') {
                        showMyWorkDetailedReport();
                    }
                }, 300);
            }
        }

        async function sendWorkReportToTelegram() {
            if (!currentWorkReportData) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á', 'error');
                return;
            }
            
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Telegram...', 'info');
                
                const reportSummary = {
                    type: currentWorkReportType,
                    technician: currentUser ? currentUser.username : 'Unknown',
                    stats: currentWorkReportData.stats,
                    metadata: currentWorkReportData.metadata
                };
                
                const response = await window.AuthUtils.apiCall('/api/admin/notifications/send-report', {
                    method: 'POST',
                    body: JSON.stringify(reportSummary)
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì±', 'success');
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô Telegram ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á: ' + error.message, 'error');
            }
        }

        // Custom Work Report Functions
        function showCustomWorkReportModal() {
            document.getElementById('customWorkReportModal').classList.add('show');
        }

        function closeCustomWorkReportModal() {
            document.getElementById('customWorkReportModal').classList.remove('show');
            document.getElementById('customWorkReportForm').reset();
        }

        async function handleCustomWorkReport(e) {
            e.preventDefault();
            
            const filters = {
                technician: currentUser.username,
                dateFrom: document.getElementById('workDateFrom').value,
                dateTo: document.getElementById('workDateTo').value,
                status: document.getElementById('workStatus').value,
                reportType: document.getElementById('workReportType').value
            };
            
            closeCustomWorkReportModal();
            
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á...', 'info');
                
                // Load and filter data for custom report
                const reportData = await loadCustomWorkReportData(filters);
                if (reportData) {
                    currentWorkReportData = reportData;
                    currentWorkReportType = 'custom';
                    
                    showWorkReportModal('custom', reportData);
                    showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéØ', 'success');
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        async function loadCustomWorkReportData(filters) {
            try {
                let filteredData = [...allRequests];
                
                // Apply custom filters
                if (filters.dateFrom) {
                    const fromDate = new Date(filters.dateFrom);
                    filteredData = filteredData.filter(r => {
                        const reqDate = new Date(r.DATE_REPORTED);
                        return reqDate >= fromDate;
                    });
                }
                
                if (filters.dateTo) {
                    const toDate = new Date(filters.dateTo);
                    toDate.setHours(23, 59, 59, 999); // End of day
                    filteredData = filteredData.filter(r => {
                        const reqDate = new Date(r.DATE_REPORTED);
                        return reqDate <= toDate;
                    });
                }
                
                if (filters.status) {
                    filteredData = filteredData.filter(r => r.STATUS === filters.status);
                }
                
                const stats = generateWorkStatistics(filteredData);
                
                return {
                    type: 'custom',
                    data: filteredData,
                    stats: stats,
                    metadata: {
                        totalRequests: filteredData.length,
                        generatedAt: new Date().toISOString(),
                        technician: currentUser ? currentUser.username : 'Unknown',
                        filters: filters,
                        dateRange: {
                            from: filters.dateFrom || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                            to: filters.dateTo || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                        }
                    }
                };
            } catch (error) {
                console.error('Error loading custom work report data:', error);
                throw error;
            }
        }

        function filterWorkByStatus(status) {
            document.getElementById('filterStatus').value = status;
            applyFilters();
            showToast(`‡∏Å‡∏£‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}`, 'info');
        }

        // Reports Functions
        function applyFilters() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const status = document.getElementById('filterStatus').value;
            
            filteredRequests = allRequests.filter(request => {
                const requestDate = new Date(request.DATE_REPORTED);
                const fromDate = dateFrom ? new Date(dateFrom) : null;
                const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null;
                
                const dateMatch = (!fromDate || requestDate >= fromDate) && 
                                 (!toDate || requestDate <= toDate);
                const statusMatch = !status || request.STATUS === status;
                
                return dateMatch && statusMatch;
            });
            
            renderFilteredResults();
        }

        function renderFilteredResults() {
            const container = document.getElementById('filteredResults');
            const badge = document.getElementById('filteredResultsBadge');
            
            if (badge) badge.textContent = `${filteredRequests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            
            if (!container) return;
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredRequests.map(request => `
                <div class="request-card" onclick='showDetailPage(${JSON.stringify(request).replace(/'/g, "&apos;")})'>
                    <div class="request-header">
                        <span class="request-id">üé´ ${request.REQUEST_ID}</span>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-badge ${getStatusClass(request.STATUS)}">${request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span>
                            <button class="btn btn-info" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" 
                                    onclick="event.stopPropagation(); showRequestInLookerStudio('${request.REQUEST_ID}')" 
                                    title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">
                                üñ®Ô∏è
                            </button>
                        </div>
                    </div>
                    <div class="request-info">
                        <span class="request-info-icon">üë§</span>
                        <span style="color: #f8fafc;">${request.TITLE_PREFIX} ${request.FIRST_NAME} ${request.LAST_NAME}</span>
                    </div>
                    <div class="request-info">
                        <span class="request-info-icon">üìÖ</span>
                        <span>${new Date(request.DATE_REPORTED).toLocaleDateString('th-TH')}</span>
                    </div>
                    <div class="request-info">
                        <span class="request-info-icon">üìç</span>
                        <span>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO}, ${request.MOO}</span>
                    </div>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin-top: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.3); border-radius: 0.5rem; border-left: 4px solid #fbbf24;">
                        <strong style="color: #fbbf24;">üîß ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> ${request.REASON}
                    </p>
                </div>
            `).join('');
        }

        // Print Functions
        function showPrintReportModal() {
            document.getElementById('printReportModal').classList.add('show');
            updatePrintPreview();
        }

        function closePrintReportModal() {
            document.getElementById('printReportModal').classList.remove('show');
        }

        function updatePrintPreview() {
            const reportType = document.getElementById('reportType').value;
            const dateFrom = document.getElementById('printDateFrom').value;
            const dateTo = document.getElementById('printDateTo').value;
            
            // Update print date and technician
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('th-TH');
            document.getElementById('printTechnician').textContent = currentUser ? currentUser.username : 'Unknown';
            
            // Filter requests for preview
            const previewRequests = allRequests.filter(request => {
                const requestDate = new Date(request.DATE_REPORTED);
                const fromDate = dateFrom ? new Date(dateFrom) : null;
                const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null;
                
                return (!fromDate || requestDate >= fromDate) && 
                       (!toDate || requestDate <= toDate);
            });
            
            generatePreviewContent(reportType, previewRequests, dateFrom, dateTo);
        }

        function generatePreviewContent(reportType, requests, dateFrom, dateTo) {
            const printContent = document.getElementById('printContent');
            
            let content = `
                <div class="print-section">
                    <div class="print-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                    <div class="print-info-grid">
                        <div class="print-info-item">
                            <div class="print-info-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                            <div class="print-info-value">${getReportTypeName(reportType)}</div>
                        </div>
                        <div class="print-info-item">
                            <div class="print-info-label">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
                            <div class="print-info-value">${formatDateRange(dateFrom, dateTo)}</div>
                        </div>
                        <div class="print-info-item">
                            <div class="print-info-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                            <div class="print-info-value">${requests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        </div>
                        <div class="print-info-item">
                            <div class="print-info-label">‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                            <div class="print-info-value">${currentUser ? currentUser.username : 'Unknown'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (reportType === 'summary') {
                content += generateSummaryContent(requests);
            } else if (reportType === 'detailed') {
                content += generateDetailedContent(requests);
            } else if (reportType === 'completed') {
                const completedRequests = requests.filter(r => r.STATUS === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                content += generateDetailedContent(completedRequests);
            }
            
            printContent.innerHTML = content;
        }

        function generateSummaryContent(requests) {
            const statusCount = {};
            requests.forEach(request => {
                const status = request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                statusCount[status] = (statusCount[status] || 0) + 1;
            });
            
            return `
                <div class="print-section">
                    <div class="print-section-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                    ${Object.keys(statusCount).map(status => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                            <span>${status}</span>
                            <span style="font-weight: bold;">${statusCount[status]} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateDetailedContent(requests) {
            if (requests.length === 0) {
                return `<div class="print-section"><p style="text-align: center; color: #6b7280;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p></div>`;
            }
            
            return `
                <div class="print-section">
                    <div class="print-section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                    ${requests.slice(0, 10).map((request, index) => `
                        <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem;">${index + 1}. ${request.REQUEST_ID}</div>
                            <div class="print-info-grid">
                                <div class="print-info-item">
                                    <div class="print-info-label">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</div>
                                    <div class="print-info-value">${request.TITLE_PREFIX} ${request.FIRST_NAME} ${request.LAST_NAME}</div>
                                </div>
                                <div class="print-info-item">
                                    <div class="print-info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>
                                    <div class="print-info-value">${request.PHONE}</div>
                                </div>
                                <div class="print-info-item">
                                    <div class="print-info-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
                                    <div class="print-info-value">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO}, ${request.MOO}</div>
                                </div>
                                <div class="print-info-item">
                                    <div class="print-info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                                    <div class="print-info-value">${request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</div>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <div class="print-info-label">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
                                <div class="print-info-value">${request.REASON}</div>
                            </div>
                        </div>
                    `).join('')}
                    ${requests.length > 10 ? `<p style="text-align: center; margin-top: 1rem; color: #6b7280;">‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${requests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>` : ''}
                </div>
            `;
        }

        function getReportTypeName(type) {
            const types = {
                'summary': '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ',
                'detailed': '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
                'completed': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'
            };
            return types[type] || type;
        }

        function formatDateRange(dateFrom, dateTo) {
            if (!dateFrom && !dateTo) return '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            if (!dateFrom) return `‡∏ñ‡∏∂‡∏á ${new Date(dateTo).toLocaleDateString('th-TH')}`;
            if (!dateTo) return `‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ${new Date(dateFrom).toLocaleDateString('th-TH')}`;
            return `${new Date(dateFrom).toLocaleDateString('th-TH')} - ${new Date(dateTo).toLocaleDateString('th-TH')}`;
        }

        function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 105, 20, { align: 'center' });
                
                doc.setFontSize(16);
                doc.text('‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà', 105, 30, { align: 'center' });
                
                // Add report info
                doc.setFontSize(12);
                const reportType = document.getElementById('reportType').value;
                const dateFrom = document.getElementById('printDateFrom').value;
                const dateTo = document.getElementById('printDateTo').value;
                
                doc.text(`‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${getReportTypeName(reportType)}`, 20, 50);
                doc.text(`‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateRange(dateFrom, dateTo)}`, 20, 60);
                doc.text(`‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${currentUser ? currentUser.username : 'Unknown'}`, 20, 70);
                doc.text(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${new Date().toLocaleDateString('th-TH')}`, 20, 80);
                
                // Add filtered data summary
                const previewRequests = allRequests.filter(request => {
                    const requestDate = new Date(request.DATE_REPORTED);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null;
                    
                    return (!fromDate || requestDate >= fromDate) && 
                           (!toDate || requestDate <= toDate);
                });
                
                doc.text(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${previewRequests.length}`, 20, 100);
                
                // Save PDF
                const fileName = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÑ', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF', 'error');
            }
        }

        function printReport() {
            const printContent = document.getElementById('printPreview').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .print-preview { background: white; color: black; }
                        .print-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #fbbf24; }
                        .print-logo { font-size: 2rem; color: #fbbf24; margin-bottom: 0.5rem; }
                        .print-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem; }
                        .print-subtitle { color: #6b7280; font-size: 0.9rem; }
                        .print-section { margin-bottom: 1.5rem; }
                        .print-section-title { font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem; }
                        .print-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
                        .print-info-item { display: flex; flex-direction: column; }
                        .print-info-label { font-weight: 500; color: #6b7280; font-size: 0.8rem; margin-bottom: 0.25rem; }
                        .print-info-value { color: #1f2937; font-size: 0.9rem; }
                        .print-footer { text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.8rem; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="print-preview">${printContent}</div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß üñ®Ô∏è', 'success');
            }, 250);
        }

        // Export Functions
        function showExportModal() {
            document.getElementById('exportModal').classList.add('show');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        async function exportToPDF() {
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...', 'info');
                
                const response = await window.AuthUtils.apiCall('/api/admin/reports/repair-requests/pdf', {
                    method: 'POST',
                    body: JSON.stringify({
                        templateOptions: {
                            title: `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ - ${new Date().toLocaleDateString('th-TH')}`,
                            headerColor: '#fbbf24',
                            showDate: true,
                            technician: currentUser ? currentUser.username : 'Unknown'
                        },
                        filterOptions: {
                            dateFrom: document.getElementById('filterDateFrom').value,
                            dateTo: document.getElementById('filterDateTo').value,
                            status: document.getElementById('filterStatus').value
                        }
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÑ', 'success');
                } else {
                    const data = await response.json();
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
            closeExportModal();
        }

        async function sendToTelegram() {
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Telegram...', 'info');
                
                const response = await window.AuthUtils.apiCall('/api/admin/notifications/send-report', {
                    method: 'POST',
                    body: JSON.stringify({
                        reportType: 'technician_summary',
                        technician: currentUser ? currentUser.username : 'Unknown',
                        filters: {
                            dateFrom: document.getElementById('filterDateFrom').value,
                            dateTo: document.getElementById('filterDateTo').value,
                            status: document.getElementById('filterStatus').value
                        }
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì±', 'success');
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô Telegram ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error sending to Telegram:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
            closeExportModal();
        }

        // Print Request Detail Functions
        function showPrintRequestDetailModal(requestId) {
            const request = allRequests.find(r => r.REQUEST_ID === requestId);
            if (!request) {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ', 'error');
                return;
            }
            
            selectedRequest = request;
            generateRequestDetailPreview(request);
            document.getElementById('printRequestDetailModal').classList.add('show');
        }

        async function showRequestInLookerStudio(requestId) {
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Looker Studio...', 'info');
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á filters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Looker Studio
                const filters = {
                    requestId: requestId,
                    type: 'request_detail'
                };
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Looker Dashboard URL
                const response = await window.AuthUtils.apiCall(`/api/admin/looker-studio/dashboard-url?type=request_detail&filters=${encodeURIComponent(JSON.stringify(filters))}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.data.url) {
                    // ‡πÄ‡∏õ‡∏¥‡∏î Looker Studio ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
                    window.open(data.data.url, '_blank');
                    showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Looker Studio ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìä', 'success');
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Looker Dashboard URL ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error opening Looker Studio:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                
                // ‡πÅ‡∏™‡∏î‡∏á fallback modal ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ó‡∏ô
                showPrintRequestDetailModal(requestId);
            }
        }

        function closePrintRequestDetailModal() {
            document.getElementById('printRequestDetailModal').classList.remove('show');
        }

        function generateRequestDetailPreview(request) {
            const preview = document.getElementById('requestDetailPreview');
            
            preview.innerHTML = `
                <div class="print-container">
                    <div class="print-header">
                        <div class="header-left">
                            <div class="address-info">
                                <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 150 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 3 ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</div>
                                <div>‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏ô ‡∏ï.‡∏´‡∏±‡∏ß‡∏ô‡∏≤</div>
                                <div>‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π 39000</div>
                            </div>
                        </div>
                        <div class="header-center">
                            <img src="https://www.huana-nbp.go.th/index/add_file/P0D284NMon35557.png" 
                                alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà" class="print-logo" 
                                onerror="this.style.display='none';">
                        </div>
                        <div class="header-right">
                            <div class="date-info">
                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏û.‡∏®. ${new Date(request.DATE_REPORTED || new Date()).toLocaleDateString('th-TH')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-title-section">
                        <div class="print-title">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á</div>
                        <div class="print-subtitle">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ô‡∏≤‡∏¢‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</div>
                    </div>
                    
                    <div class="print-content">
                        <div class="form-section">
                            <div class="form-line">
                                <span>‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤</span>
                                <span class="underline-field">${request.TITLE_PREFIX || ''} ${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}</span>
                                <span>‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                <span class="underline-field">${request.AGE || ''}</span>
                                <span>‡∏õ‡∏µ ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡∏ï‡∏¥</span>
                                <span class="underline-field">${request.ETHNICITY || '‡πÑ‡∏ó‡∏¢'}</span>
                            </div>
                            
                            <div class="form-line">
                                <span>‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥</span>
                                <span class="underline-field">${request.NATIONALITY || '‡πÑ‡∏ó‡∏¢'}</span>
                                <span>‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</span>
                                <span class="underline-field">${request.HOUSE_NO || ''}</span>
                                <span>‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</span>
                                <span class="underline-field">${request.MOO || ''}</span>
                            </div>
                            
                            <div class="form-line">
                                <span>‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π</span>
                            </div>
                            
                            <div class="form-line">
                                <span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span>
                                <span class="underline-field">${request.PHONE || ''}</span>
                                <span>‡∏Ç‡∏≠‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á</span>
                            </div>
                            
                            <div class="form-line">
                                <span>‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á</span>
                                <span class="underline-field">${request.POLE_ID || ''}</span>
                            </div>
                            
                            <div class="form-line">
                                <span>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å</span>
                                <span class="underline-field wide">${request.REASON || ''}</span>
                            </div>
                            
                            ${request.PROBLEM_DESCRIPTION ? `
                            <div class="form-line">
                                <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                                <span class="underline-field wide">${request.PROBLEM_DESCRIPTION}</span>
                            </div>
                            ` : ''}
                            
                            <div class="signature-section">
                                <div class="signature-box">
                                    <div>(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠)...................................................‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</div>
                                    <div class="signature-name">( ${request.TITLE_PREFIX || ''} ${request.FIRST_NAME || ''} ${request.LAST_NAME || ''} )</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="approval-section">
                            <div class="approval-row">
                                <div class="approval-box">
                                    <div class="approval-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>
                                    <div class="approval-content">
                                        ${request.STAFF_NOTES || '................................................\n................................................'}
                                    </div>
                                    <div class="approval-signature">
                                        <div>(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠)..................................................</div>
                                        <div>(.................................................)</div>
                                    </div>
                                </div>
                                
                                <div class="approval-box">
                                    <div class="approval-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á</div>
                                    <div class="approval-content">
                                        ${request.ENGINEER_DIRECTOR_NOTES || '................................................\n................................................'}
                                    </div>
                                    <div class="approval-signature">
                                        <div>(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠)..................................................</div>
                                        <div>(.................................................)</div>
                                        <div>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approval-row">
                                <div class="approval-box">
                                    <div class="approval-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏•‡∏±‡∏î ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</div>
                                    <div class="approval-content">
                                        ${request.DEPUTY_NOTES || '................................................\n................................................'}
                                    </div>
                                    <div class="approval-signature">
                                        <div>(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠)..................................................</div>
                                        <div>(.................................................)</div>
                                    </div>
                                </div>
                                
                                <div class="approval-box">
                                    <div class="approval-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏≤‡∏¢‡∏Å ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</div>
                                    <div class="approval-content">
                                        ${request.MAYOR_NOTES || '................................................\n................................................'}
                                    </div>
                                    <div class="approval-signature">
                                        <div>(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠)..................................................</div>
                                        <div>(.................................................)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${request.TECHNICIAN_NOTES ? `
                        <div class="technician-notes-section">
                            <div class="section-title">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</div>
                            <div class="notes-content">${request.TECHNICIAN_NOTES}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="print-footer">
                        <div class="footer-info">
                            <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${request.REQUEST_ID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</div>
                            <div>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleDateString('th-TH')} ‡πÄ‡∏ß‡∏•‡∏≤ ${new Date().toLocaleTimeString('th-TH')}</div>
                            <div>‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ: ${currentUser ? currentUser.username : '‡∏£‡∏∞‡∏ö‡∏ö'}</div>
                        </div>
                    </div>
                </div>
                
                <style>
                    .print-container {
                        max-width: 210mm;
                        margin: 0 auto;
                        padding: 20mm;
                        background: white;
                        font-family: 'Sarabun', 'TH SarabunPSK', sans-serif;
                        font-size: 14px;
                        line-height: 1.5;
                        color: #000;
                    }
                    
                    .print-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 20px;
                        border-bottom: 1px solid #ddd;
                        padding-bottom: 15px;
                    }
                    
                    .header-left, .header-right {
                        flex: 1;
                    }
                    
                    .header-center {
                        flex: 0 0 auto;
                        text-align: center;
                        margin: 0 20px;
                    }
                    
                    .print-logo {
                        max-width: 80px;
                        max-height: 80px;
                        object-fit: contain;
                    }
                    
                    .address-info div {
                        margin-bottom: 2px;
                        font-size: 12px;
                    }
                    
                    .date-info {
                        text-align: right;
                        font-size: 12px;
                    }
                    
                    .print-title-section {
                        text-align: center;
                        margin-bottom: 30px;
                    }
                    
                    .print-title {
                        font-size: 18px;
                        font-weight: bold;
                        margin-bottom: 10px;
                    }
                    
                    .print-subtitle {
                        font-size: 16px;
                        margin-bottom: 20px;
                    }
                    
                    .form-section {
                        margin-bottom: 30px;
                    }
                    
                    .form-line {
                        margin-bottom: 15px;
                        display: flex;
                        align-items: baseline;
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                    
                    .underline-field {
                        border-bottom: 1px dotted #333;
                        min-width: 100px;
                        padding: 2px 5px;
                        display: inline-block;
                        font-weight: 500;
                    }
                    
                    .underline-field.wide {
                        min-width: 300px;
                        flex: 1;
                    }
                    
                    .signature-section {
                        margin: 30px 0;
                        text-align: right;
                    }
                    
                    .signature-box {
                        display: inline-block;
                        text-align: center;
                    }
                    
                    .signature-name {
                        margin-top: 5px;
                    }
                    
                    .approval-section {
                        margin-top: 40px;
                        border-top: 2px solid #333;
                        padding-top: 20px;
                    }
                    
                    .approval-row {
                        display: flex;
                        margin-bottom: 30px;
                        gap: 20px;
                    }
                    
                    .approval-box {
                        flex: 1;
                        border: 1px solid #ddd;
                        padding: 15px;
                        min-height: 120px;
                    }
                    
                    .approval-title {
                        font-weight: bold;
                        text-align: center;
                        margin-bottom: 10px;
                        border-bottom: 1px solid #ddd;
                        padding-bottom: 5px;
                    }
                    
                    .approval-content {
                        min-height: 60px;
                        margin-bottom: 15px;
                        white-space: pre-line;
                        font-size: 13px;
                    }
                    
                    .approval-signature {
                        text-align: center;
                        font-size: 12px;
                    }
                    
                    .approval-signature div {
                        margin-bottom: 3px;
                    }
                    
                    .technician-notes-section {
                        margin-top: 30px;
                        border: 2px solid #333;
                        padding: 15px;
                        background-color: #f9f9f9;
                    }
                    
                    .section-title {
                        font-weight: bold;
                        font-size: 16px;
                        margin-bottom: 10px;
                        text-align: center;
                        background-color: #e0e0e0;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    
                    .notes-content {
                        white-space: pre-line;
                        line-height: 1.6;
                    }
                    
                    .print-footer {
                        margin-top: 40px;
                        border-top: 1px solid #ddd;
                        padding-top: 15px;
                    }
                    
                    .footer-info {
                        display: flex;
                        justify-content: space-between;
                        font-size: 12px;
                        color: #666;
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                    
                    @media print {
                        .print-container {
                            margin: 0;
                            padding: 15mm;
                            box-shadow: none;
                        }
                        
                        .approval-row {
                            page-break-inside: avoid;
                        }
                        
                        .technician-notes-section {
                            page-break-inside: avoid;
                        }
                    }
                </style>
            `;
        }

        function generateRequestPDF() {
            if (!selectedRequest) return;
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 105, 20, { align: 'center' });
                
                doc.setFontSize(16);
                doc.text('‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà', 105, 30, { align: 'center' });
                
                // Add request details
                doc.setFontSize(12);
                let yPosition = 50;
                
                doc.text(`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${selectedRequest.REQUEST_ID}`, 20, yPosition);
                yPosition += 10;
                doc.text(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${new Date(selectedRequest.DATE_REPORTED).toLocaleDateString('th-TH')}`, 20, yPosition);
                yPosition += 10;
                doc.text(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${selectedRequest.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}`, 20, yPosition);
                yPosition += 20;
                
                doc.text('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:', 20, yPosition);
                yPosition += 10;
                doc.text(`‡∏ä‡∏∑‡πà‡∏≠: ${selectedRequest.TITLE_PREFIX} ${selectedRequest.FIRST_NAME} ${selectedRequest.LAST_NAME}`, 30, yPosition);
                yPosition += 10;
                doc.text(`‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${selectedRequest.PHONE}`, 30, yPosition);
                yPosition += 10;
                doc.text(`‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${selectedRequest.HOUSE_NO}, ${selectedRequest.MOO}`, 30, yPosition);
                yPosition += 20;
                
                doc.text('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤:', 20, yPosition);
                yPosition += 10;
                doc.text(`‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${selectedRequest.REASON}`, 30, yPosition);
                
                if (selectedRequest.TECHNICIAN_NOTES) {
                    yPosition += 20;
                    doc.text('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≤‡∏á:', 20, yPosition);
                    yPosition += 10;
                    doc.text(selectedRequest.TECHNICIAN_NOTES, 30, yPosition);
                }
                
                // Add footer
                doc.setFontSize(10);
                doc.text(`‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleDateString('th-TH')} | ‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ: ${currentUser ? currentUser.username : 'Unknown'}`, 105, 280, { align: 'center' });
                
                // Save PDF
                const fileName = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô_${selectedRequest.REQUEST_ID}.pdf`;
                doc.save(fileName);
                
                showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÑ', 'success');
            } catch (error) {
                console.error('Error generating request PDF:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF', 'error');
            }
        }

        function printRequestDetail() {
            if (!selectedRequest) return;
            
            const printContent = document.getElementById('requestDetailPreview').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° - ${selectedRequest.REQUEST_ID}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .print-preview { background: white; color: black; }
                        .print-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #fbbf24; }
                        .print-logo { font-size: 2rem; color: #fbbf24; margin-bottom: 0.5rem; }
                        .print-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem; }
                        .print-subtitle { color: #6b7280; font-size: 0.9rem; }
                        .print-section { margin-bottom: 1.5rem; }
                        .print-section-title { font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem; }
                        .print-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
                        .print-info-item { display: flex; flex-direction: column; }
                        .print-info-label { font-weight: 500; color: #6b7280; font-size: 0.8rem; margin-bottom: 0.25rem; }
                        .print-info-value { color: #1f2937; font-size: 0.9rem; }
                        .print-footer { text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.8rem; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="print-preview">${printContent}</div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß üñ®Ô∏è', 'success');
            }, 250);
        }

        function renderInventoryList() {
            const container = document.getElementById('inventoryList');
            if (!container) return;
            
            if (allInventory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allInventory.map(item => `
                <div class="inventory-item">
                    <div class="inventory-header">
                        <div class="inventory-name">üì¶ ${item.ITEM_NAME}</div>
                        <div class="inventory-stock">
                            <span class="stock-badge ${item.CURRENT_STOCK < 10 ? 'stock-low' : 'stock-normal'}">
                                ${item.CURRENT_STOCK} ${item.UNIT}
                            </span>
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.75rem;">
                        üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.PRICE_PER_UNIT} ‡∏ö‡∏≤‡∏ó/${item.UNIT}
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="showAdjustInventoryModal('${item.ITEM_NAME}', ${item.CURRENT_STOCK})">
                            ‚öôÔ∏è
                        </button>
                        <span style="font-size: 0.9rem; color: #94a3b8;">‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                    </div>
                </div>
            `).join('');
        }

        function renderPolesList() {
            const container = document.getElementById('polesList');
            if (!container) return;
            
            if (filteredPoles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üóº</div>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                    </div>
                `;
                updatePolesPagination();
                return;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPagePoles = filteredPoles.slice(startIndex, endIndex);
            const polesByVillage = groupPolesByVillage(currentPagePoles);
            
            let html = '';
            Object.keys(polesByVillage).sort().forEach(village => {
                const poles = polesByVillage[village];
                html += `
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05)); padding: 1rem; margin: -2rem -2rem 1.5rem -2rem; border-radius: 1rem 1rem 0 0; border-bottom: 1px solid rgba(251, 191, 36, 0.2);">
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: #fbbf24; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                üìç ${village} <span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.8rem;">${poles.length} ‡πÄ‡∏™‡∏≤</span>
                            </h3>
                        </div>
                        <div style="display: grid; gap: 1rem;">
                            ${poles.map(pole => `
                                <div class="inventory-item" style="border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 0.75rem; background: linear-gradient(135deg, rgba(15, 23, 42, 0.4), rgba(30, 41, 59, 0.2));">
                                    <div class="inventory-header">
                                        <div class="inventory-name" style="color: #fbbf24;">
                                            üóº ‡∏£‡∏´‡∏±‡∏™: <strong>${pole.POLE_ID_HEADER}</strong>
                                        </div>
                                        <div class="inventory-stock">
                                            <span class="stock-badge stock-normal" style="font-size: 0.8rem; background: rgba(16, 185, 129, 0.2); color: #86efac;">
                                                ${pole.POLE_TYPE_HEADER || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'}
                                            </span>
                                        </div>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.75rem; display: grid; gap: 0.5rem;">
                                        ${pole.POLE_SUBTYPE_HEADER ? `<div>üîß ‡∏ä‡∏ô‡∏¥‡∏î: ${pole.POLE_SUBTYPE_HEADER}</div>` : ''}
                                        ${pole.LAMP_TYPE_HEADER ? `<div>üí° ‡∏´‡∏•‡∏≠‡∏î: ${pole.LAMP_TYPE_HEADER} ${pole.WATTAGE_HEADER ? `(${pole.WATTAGE_HEADER} ‡∏ß‡∏±‡∏ï‡∏ï‡πå)` : ''}</div>` : ''}
                                        ${pole.INSTALL_DATE_HEADER ? `<div>üìÖ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á: ${new Date(pole.INSTALL_DATE_HEADER).toLocaleDateString('th-TH')}</div>` : ''}
                                        ${pole.LATITUDE_HEADER && pole.LONGITUDE_HEADER ? `
                                            <div style="color: #10b981;">üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${parseFloat(pole.LATITUDE_HEADER).toFixed(4)}, ${parseFloat(pole.LONGITUDE_HEADER).toFixed(4)}</div>
                                        ` : ''}
                                        ${pole.NOTES_HEADER ? `<div>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${pole.NOTES_HEADER}</div>` : ''}
                                    </div>
                                    ${pole.LATITUDE_HEADER && pole.LONGITUDE_HEADER ? `
                                        <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                                            <button class="navigation-btn" onclick="navigateToPole(${pole.LATITUDE_HEADER}, ${pole.LONGITUDE_HEADER})" style="flex: 1; margin: 0; padding: 0.75rem;">
                                                üó∫Ô∏è ‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                                            </button>
                                            <button class="btn btn-warning" onclick="editPole('${pole.POLE_ID_HEADER}')" style="padding: 0.75rem; font-size: 0.8rem;">
                                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                            </button>
                                        </div>
                                    ` : `
                                        <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                                            <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 0.5rem; padding: 0.75rem; flex: 1; font-size: 0.8rem; color: #fcd34d;">
                                                ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
                                            </div>
                                            <button class="btn btn-warning" onclick="editPole('${pole.POLE_ID_HEADER}')" style="padding: 0.75rem; font-size: 0.8rem;">
                                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                            </button>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            updatePolesPagination();
            updatePolesPageStats();
        }

        function groupPolesByVillage(poles) {
            const grouped = {};
            poles.forEach(pole => {
                const village = pole.VILLAGE_HEADER || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô';
                if (!grouped[village]) grouped[village] = [];
                grouped[village].push(pole);
            });
            return grouped;
        }

        function updatePolesPageStats() {
            const villages = [...new Set(allPoles.map(pole => pole.VILLAGE_HEADER).filter(Boolean))];
            
            const totalPolesEl = document.getElementById('totalPolesCount');
            if (totalPolesEl) totalPolesEl.textContent = allPoles.length;
            const villageCountEl = document.getElementById('villageCount');
            if (villageCountEl) villageCountEl.textContent = villages.length;
            const filteredCountEl = document.getElementById('filteredCount');
            if (filteredCountEl) filteredCountEl.textContent = filteredPoles.length;
            
            const villageFilter = document.getElementById('villageFilter');
            if (villageFilter) {
                const currentVal = villageFilter.value;
                villageFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                villages.sort().forEach(village => {
                    const option = document.createElement('option');
                    option.value = village;
                    option.textContent = village;
                    villageFilter.appendChild(option);
                });
                villageFilter.value = currentVal;
            }
        }

        function updatePolesPagination() {
            const totalPages = Math.ceil(filteredPoles.length / itemsPerPage);
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationElement = document.getElementById('polesPagination');

            if (!prevBtn || !nextBtn || !paginationInfo || !paginationElement) return;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            if (totalPages > 0) {
                const startItem = (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, filteredPoles.length);
                paginationInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á ${startItem}-${endItem} ‡∏à‡∏≤‡∏Å ${filteredPoles.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}/${totalPages})`;
            } else {
                paginationInfo.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
            paginationElement.style.display = totalPages <= 1 ? 'none' : 'block';
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredPoles.length / itemsPerPage);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderPolesList();
            }
        }

        function filterByVillage() {
            const villageFilterEl = document.getElementById('villageFilter');
            if (villageFilterEl) currentVillageFilter = villageFilterEl.value;
            currentPage = 1; 
            applyFiltersAndRenderPoles();
        }

        function searchPoles() {
            const poleSearchInputEl = document.getElementById('poleSearchInput');
            if (poleSearchInputEl) currentSearchQuery = poleSearchInputEl.value.toLowerCase().trim();
            currentPage = 1; 
            applyFiltersAndRenderPoles();
        }

        function applyFiltersAndRenderPoles() {
            filteredPoles = allPoles.filter(pole => {
                const villageMatch = !currentVillageFilter || pole.VILLAGE_HEADER === currentVillageFilter;
                const searchMatch = !currentSearchQuery || 
                    (pole.POLE_ID_HEADER && pole.POLE_ID_HEADER.toLowerCase().includes(currentSearchQuery)) ||
                    (pole.VILLAGE_HEADER && pole.VILLAGE_HEADER.toLowerCase().includes(currentSearchQuery)) ||
                    (pole.POLE_TYPE_HEADER && pole.POLE_TYPE_HEADER.toLowerCase().includes(currentSearchQuery)) ||
                    (pole.NOTES_HEADER && pole.NOTES_HEADER.toLowerCase().includes(currentSearchQuery));
                return villageMatch && searchMatch;
            });
            renderPolesList();
        }

        function renderRequestDetail() {
            const request = selectedRequest;
            const detailsContainer = document.getElementById('requestDetails');
            const actionButtonsContainer = document.getElementById('actionButtons');
            if (!detailsContainer || !actionButtonsContainer) return;

            detailsContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
                    <h2 style="font-size: 1.3rem; font-weight: 700; color: #fbbf24;">üé´ ${request.REQUEST_ID}</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span class="status-badge ${getStatusClass(request.STATUS)}">${request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span>
                        <button class="btn btn-info" style="padding: 0.5rem 0.75rem; font-size: 0.8rem;" 
                                onclick="showRequestInLookerStudio('${request.REQUEST_ID}')" 
                                title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
                        </button>
                    </div>
                </div>
                <div style="display: grid; gap: 1.5rem;">
                    <div class="detail-section">
                        <div class="detail-label">üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</div>
                        <div class="detail-value">${request.TITLE_PREFIX} ${request.FIRST_NAME} ${request.LAST_NAME}</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</div>
                        <div class="detail-value">
                            <a href="tel:${request.PHONE}" style="color: #10b981; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                                üìû ${request.PHONE}
                            </a>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
                        <div class="detail-value">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO}, ${request.MOO}</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">‚ö° ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</div>
                        <div class="detail-value" style="display: flex; align-items: center; gap: 0.75rem;">
                            <span>${request.POLE_ID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                            ${request.POLE_ID && request.POLE_ID !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' ? `
                                <button class="btn btn-info" style="padding: 0.5rem 0.75rem; font-size: 0.8rem;" onclick="navigateToRequestPole('${request.POLE_ID}')">
                                    üó∫Ô∏è ‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">üîß ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∏‡∏î</div>
                        <div class="detail-value">${request.REASON}</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</div>
                        <div class="detail-value">${new Date(request.DATE_REPORTED).toLocaleDateString('th-TH')}</div>
                    </div>
                    ${request.TECHNICIAN_NOTES ? `
                        <div class="detail-section">
                            <div class="detail-label">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≤‡∏á</div>
                            <div class="detail-value">${request.TECHNICIAN_NOTES}</div>
                        </div>
                    ` : ''}
                    ${request.APPROVED_BY ? `
                        <div class="detail-section">
                            <div class="detail-label">üëë ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                            <div class="detail-value">${request.APPROVED_BY}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            let buttonsHTML = '';
            if (request.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á') {
                buttonsHTML = `<button class="btn btn-warning w-full" onclick="startWork('${request.REQUEST_ID}')">‚öôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>`;
            } else if (request.STATUS === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                buttonsHTML = `
                    <div class="action-buttons-row">
                        <button class="btn btn-success" onclick="completeWork('${request.REQUEST_ID}')">‚úÖ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button>
                        <button class="btn btn-secondary" onclick="addNote('${request.REQUEST_ID}')">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
                    </div>`;
            } else if (request.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                buttonsHTML = `<div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 0.75rem; padding: 1.5rem; color: #fcd34d; text-align: center;">‚è∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</div>`;
            } else if (request.STATUS === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') {
                buttonsHTML = `<div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(21, 128, 61, 0.1)); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 0.75rem; padding: 1.5rem; color: #86efac; text-align: center;">‚úÖ ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>`;
            }
            actionButtonsContainer.innerHTML = buttonsHTML;
        }

        async function navigateToRequestPole(poleId) {
            try {
                const response = await window.AuthUtils.apiCall(`/api/admin/poles/${encodeURIComponent(poleId)}`);
                const data = await response.json();
                if (data.status === 'success' && data.data) {
                    const pole = data.data;
                    if (pole.LATITUDE_HEADER && pole.LONGITUDE_HEADER) {
                        navigateToPole(pole.LATITUDE_HEADER, pole.LONGITUDE_HEADER);
                    } else {
                        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ô‡∏µ‡πâ', 'error');
                    }
                } else {
                    showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 'error');
                }
            } catch (error) {
                console.error('Error fetching pole data:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 'error');
            }
        }

        function navigateToPole(latitude, longitude) {
            const url = `https://www.google.com/maps?q=${latitude},${longitude}`;
            window.open(url, '_blank');
        }

        async function startWork(requestId) {
            showConfirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', async () => {
                await updateRequestStatus(requestId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏ä‡πà‡∏≤‡∏á');
            });
        }

        async function completeWork(requestId) {
            showPrompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):', '', async (notes) => {
                 if (notes === null) return;
                 const finalNotes = notes.trim() || '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                 await updateRequestStatus(requestId, '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', finalNotes);
            });
        }

        async function addNote(requestId) {
             showPrompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:', '', async (notes) => {
                if (notes === null || !notes.trim()) return;
                await updateRequestStatus(requestId, null, notes.trim());
            });
        }

        async function updateRequestStatus(requestId, newStatus, notes) {
            try {
                const response = await window.AuthUtils.apiCall(`/api/admin/repair-request/${requestId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        newStatus: newStatus,
                        technicianNotes: notes
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚ö°', 'success');
                    await loadData();
                    if (newStatus) {
                        showDashboard();
                    } else {
                        const updatedRequest = allRequests.find(r => r.REQUEST_ID === requestId);
                        if (updatedRequest) {
                            selectedRequest = updatedRequest;
                            renderRequestDetail();
                        } else {
                             showDashboard();
                        }
                    }
                } else {
                    throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            } catch (error) {
                console.error('Error updating request status:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + error.message, 'error');
            }
        }

        function getRoleDisplayName(role) {
            const roles = {
                'admin': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                'executive': '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',
                'technician': '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ'
            };
            return roles[role] || role;
        }

        function getStatusClass(status) {
            switch (status) {
                case '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': return 'status-pending';
                case '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á': return 'status-approved';
                case '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': return 'status-in-progress';
                case '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': return 'status-completed';
                default: return 'status-pending';
            }
        }

        // Inventory Management Functions
        function showAddInventoryModal() {
            document.getElementById('addInventoryModal').classList.add('show');
        }
        function closeAddInventoryModal() {
            document.getElementById('addInventoryModal').classList.remove('show');
            document.getElementById('addInventoryForm').reset();
        }
        async function handleAddInventory(e) {
            e.preventDefault();
            const itemData = {
                itemName: document.getElementById('itemName').value.trim(),
                unit: document.getElementById('itemUnit').value.trim(),
                pricePerUnit: parseFloat(document.getElementById('itemPrice').value),
                currentStock: parseInt(document.getElementById('itemStock').value)
            };
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/inventory', {
                    method: 'POST',
                    body: JSON.stringify(itemData)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì¶', 'success');
                    closeAddInventoryModal();
                    loadInventory();
                } else { throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
            } catch (error) {
                console.error('Error adding inventory:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ' + error.message, 'error');
            }
        }
        function showAdjustInventoryModal(itemName, currentStock) {
            selectedInventoryItem = { name: itemName, stock: currentStock };
            document.getElementById('adjustItemName').textContent = itemName;
            document.getElementById('adjustCurrentStock').textContent = currentStock;
            document.getElementById('adjustInventoryModal').classList.add('show');
        }
        function closeAdjustInventoryModal() {
            document.getElementById('adjustInventoryModal').classList.remove('show');
            document.getElementById('adjustQuantity').value = '';
            selectedInventoryItem = null;
        }
        async function confirmAdjustInventory() {
            const adjustType = document.getElementById('adjustType').value;
            const quantity = parseInt(document.getElementById('adjustQuantity').value);
            if (!quantity || quantity <= 0) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/inventory/adjust', {
                    method: 'POST',
                    body: JSON.stringify({
                        itemName: selectedInventoryItem.name,
                        quantityChange: quantity,
                        transactionType: adjustType
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚öôÔ∏è', 'success');
                    closeAdjustInventoryModal();
                    loadInventory();
                } else { throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
            } catch (error) {
                console.error('Error adjusting inventory:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ' + error.message, 'error');
            }
        }

        // Geolocation Functions
        function getCurrentLocation(mode) {
            if (!navigator.geolocation) {
                showToast('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS', 'error');
                return;
            }
            const btn = mode === 'add' ? document.getElementById('getLocationBtn') : document.getElementById('editGetLocationBtn');
            const statusDiv = mode === 'add' ? document.getElementById('locationStatus') : document.getElementById('editLocationStatus');
            const latInput = mode === 'add' ? document.getElementById('poleLatitude') : document.getElementById('editPoleLatitude');
            const lngInput = mode === 'add' ? document.getElementById('poleLongitude') : document.getElementById('editPoleLongitude');

            btn.disabled = true;
            btn.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...';
            statusDiv.style.color = '#3b82f6';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    latInput.value = position.coords.latitude.toFixed(6);
                    lngInput.value = position.coords.longitude.toFixed(6);
                    statusDiv.innerHTML = `‚úÖ ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ¬±${Math.round(position.coords.accuracy)} ‡πÄ‡∏°‡∏ï‡∏£`;
                    statusDiv.style.color = '#10b981';
                    btn.disabled = false;
                    btn.innerHTML = 'üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    setTimeout(() => { statusDiv.style.display = 'none'; btn.innerHTML = 'üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'; }, 5000);
                },
                function(error) {
                    let errMsg = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED: errMsg += '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'; break;
                        case error.POSITION_UNAVAILABLE: errMsg += '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ'; break;
                        case error.TIMEOUT: errMsg += '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'; break;
                        default: errMsg += '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'; break;
                    }
                    statusDiv.innerHTML = errMsg;
                    statusDiv.style.color = '#ef4444';
                    btn.disabled = false;
                    btn.innerHTML = 'üìç ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    setTimeout(() => { statusDiv.style.display = 'none'; btn.innerHTML = 'üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'; }, 8000);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
            );
        }

        function showAddPoleModal() { document.getElementById('addPoleModal').classList.add('show'); }
        function closeAddPoleModal() { document.getElementById('addPoleModal').classList.remove('show'); document.getElementById('addPoleForm').reset(); }
        function showEditPoleModal() { document.getElementById('editPoleModal').classList.add('show'); }
        function closeEditPoleModal() { document.getElementById('editPoleModal').classList.remove('show'); document.getElementById('editPoleForm').reset(); }

        async function editPole(poleId) {
            try {
                const response = await window.AuthUtils.apiCall(`/api/admin/poles/${encodeURIComponent(poleId)}`);
                const data = await response.json();
                if (data.status === 'success' && data.data) {
                    const pole = data.data;
                    document.getElementById('editPoleOriginalId').value = pole.POLE_ID_HEADER || '';
                    document.getElementById('editPoleId').value = pole.POLE_ID_HEADER || '';
                    document.getElementById('editPoleVillage').value = pole.VILLAGE_HEADER || '';
                    document.getElementById('editPoleType').value = pole.POLE_TYPE_HEADER || '';
                    document.getElementById('editPoleSubtype').value = pole.POLE_SUBTYPE_HEADER || '';
                    document.getElementById('editPoleLatitude').value = pole.LATITUDE_HEADER || '';
                    document.getElementById('editPoleLongitude').value = pole.LONGITUDE_HEADER || '';
                    document.getElementById('editPoleLampType').value = pole.LAMP_TYPE_HEADER || '';
                    document.getElementById('editPoleWattage').value = pole.WATTAGE_HEADER || '';
                    document.getElementById('editPoleInstallDate').value = pole.INSTALL_DATE_HEADER ? pole.INSTALL_DATE_HEADER.split('T')[0] : '';
                    document.getElementById('editPoleInstallCompany').value = pole.INSTALL_COMPANY_HEADER || '';
                    document.getElementById('editPoleNotes').value = pole.NOTES_HEADER || '';
                    showEditPoleModal();
                } else { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 'error'); }
            } catch (error) {
                console.error('Error loading pole data:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤: ' + error.message, 'error');
            }
        }

        async function handleAddPole(e) {
            e.preventDefault();
            const poleData = {
                poleId: document.getElementById('poleId').value.trim(),
                village: document.getElementById('poleVillage').value.trim(),
                poleType: document.getElementById('poleType').value,
                poleSubtype: document.getElementById('poleSubtype').value.trim(),
                latitude: document.getElementById('poleLatitude').value,
                longitude: document.getElementById('poleLongitude').value,
                lampType: document.getElementById('poleLampType').value.trim(),
                wattage: document.getElementById('poleWattage').value,
                installDate: document.getElementById('poleInstallDate').value,
                installCompany: document.getElementById('poleInstallCompany').value.trim(),
                notes: document.getElementById('poleNotes').value.trim()
            };
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/poles', {
                    method: 'POST',
                    body: JSON.stringify(poleData)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üóº', 'success');
                    closeAddPoleModal();
                    await loadPoles();
                } else { throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
            } catch (error) {
                console.error('Error adding pole:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤: ' + error.message, 'error');
            }
        }

        async function handleEditPole(e) {
            e.preventDefault();
            const originalPoleId = document.getElementById('editPoleOriginalId').value;
            const poleData = {
                poleId: document.getElementById('editPoleId').value.trim(),
                village: document.getElementById('editPoleVillage').value.trim(),
                poleType: document.getElementById('editPoleType').value,
                poleSubtype: document.getElementById('editPoleSubtype').value.trim(),
                latitude: document.getElementById('editPoleLatitude').value,
                longitude: document.getElementById('editPoleLongitude').value,
                lampType: document.getElementById('editPoleLampType').value.trim(),
                wattage: document.getElementById('editPoleWattage').value,
                installDate: document.getElementById('editPoleInstallDate').value,
                installCompany: document.getElementById('editPoleInstallCompany').value.trim(),
                notes: document.getElementById('editPoleNotes').value.trim()
            };
            try {
                const response = await window.AuthUtils.apiCall(`/api/admin/poles/${encodeURIComponent(originalPoleId)}`, {
                    method: 'PUT',
                    body: JSON.stringify(poleData)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úèÔ∏è', 'success');
                    closeEditPoleModal();
                    await loadPoles();
                } else { throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
            } catch (error) {
                console.error('Error updating pole:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤: ' + error.message, 'error');
            }
        }

        // Change Password Modal
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show');
        }
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
            document.getElementById('changePasswordForm').reset();
        }
        async function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPasswordChange').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmNewPassword) {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error');
                return;
            }
             if (newPassword.length < 6) { 
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
                return;
            }
            try {
                const response = await window.AuthUtils.apiCall('/api/user/change-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: currentUser.username,
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! üîë', 'success');
                    closeChangePasswordModal();
                } else { throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ'); }
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ' + error.message, 'error');
            }
        }
        
        function handleLogout() {
            showConfirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                if (window.AuthUtils && typeof window.AuthUtils.logout === 'function') {
                    window.AuthUtils.logout();
                } else if (window.AuthUtils && typeof window.AuthUtils.forceLogout === 'function') {
                    window.AuthUtils.forceLogout();
                } else {
                    localStorage.removeItem('authToken'); 
                    localStorage.removeItem('authUser'); 
                    window.location.href = '/login.html'; 
                }
            });
        }

        // SweetAlert2 Functions
        function showToast(message, type = 'info') {
            const iconMap = {
                'success': 'success',
                'error': 'error',
                'warning': 'warning',
                'info': 'info'
            };

            Swal.fire({
                icon: iconMap[type] || 'info',
                title: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: false,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
        }

        function showConfirm(message, onConfirm, onCancel) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                text: message,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed && onConfirm) {
                    onConfirm();
                } else if (result.isDismissed && onCancel) {
                    onCancel();
                }
            });
        }
        
        function showPrompt(message, defaultValue = '', callback) {
            Swal.fire({
                title: '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: message,
                input: 'textarea',
                inputValue: defaultValue,
                inputPlaceholder: '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£...',
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => {
                    // Allow empty input by returning null
                    return null;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    callback(result.value || '');
                } else {
                    callback(null);
                }
            });
        }

        // Auto refresh data when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && window.AuthUtils && typeof window.AuthUtils.isAuthenticated === 'function' && window.AuthUtils.isAuthenticated()) {
                loadData();
                 if (currentUser) { 
                    initializeApp();
                }
            }
        });

        // Click outside modals to close
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
            if (e.target.classList.contains('report-modal')) {
                closeWorkSummaryReportModal();
            }
        });
    </script>
</body>
</html>